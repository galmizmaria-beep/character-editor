<div id="FX_ROOT">
    <style>
        /* --- –®–†–ò–§–¢–´ --- */
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Montserrat:wght@400;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        /* --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï --- */
        #FX_ROOT {
            --bg-dark: #050505;
            --bg-panel: rgba(18, 18, 24, 0.98);
            --cyan: #00e5ff;
            --pink: #ff0055;
            --green: #00ff88;
            --text: #ffffff;
            --border: rgba(255, 255, 255, 0.15);
            width: 100%;
            height: 100%;
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-dark);
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--text);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #FX_ROOT * { box-sizing: border-box; user-select: none; outline: none; }
        
        /* --- UI –≠–õ–ï–ú–ï–ù–¢–´ --- */
        .fx-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            color: var(--text); padding: 8px; cursor: pointer;
            font-family: 'Rajdhani', sans-serif; font-weight: 700;
            text-transform: uppercase; transition: 0.2s; border-radius: 4px;
            font-size: 11px; text-align: center;
        }
        .fx-btn:hover { border-color: var(--cyan); color: var(--cyan); background: rgba(0, 229, 255, 0.1); }
        .fx-btn.active { background: var(--cyan); color: #000; border-color: var(--cyan); box-shadow: 0 0 10px rgba(0,229,255,0.4); }

        .fx-input, .fx-textarea {
            background: #000; border: 1px solid var(--border); color: #fff;
            padding: 8px; width: 100%; font-size: 11px;
            border-radius: 4px; font-family: monospace; transition: 0.3s;
            margin-bottom: 5px;
        }
        .fx-input:focus, .fx-textarea:focus { border-color: var(--cyan); }
        .upload-success { border-color: var(--green) !important; box-shadow: 0 0 10px var(--green) !important; }

        /* --- –†–ï–î–ê–ö–¢–û–† --- */
        .view-editor { flex: 1; display: flex; opacity: 1; pointer-events: auto; }

        /* –°–∞–π–¥–±–∞—Ä */
        .sidebar {
            width: 380px; background: var(--bg-panel);
            border-right: 1px solid var(--border); display: flex; flex-direction: column;
            z-index: 10; box-shadow: 5px 0 20px rgba(0,0,0,0.5);
        }
        .sidebar-content { flex: 1; overflow-y: auto; }
        #FX_ROOT .sidebar-content::-webkit-scrollbar { width: 5px; }
        #FX_ROOT .sidebar-content::-webkit-scrollbar-track { background: #000; }
        #FX_ROOT .sidebar-content::-webkit-scrollbar-thumb { background: var(--cyan); border-radius: 3px; }

        .main-tabs { display: flex; border-bottom: 2px solid var(--border); }
        .main-tab-link {
            flex: 1; padding: 15px 5px; text-align: center;
            background: rgba(0,0,0,0.2); border: none; color: #888;
            font-weight: 900; text-transform: uppercase; cursor: pointer;
            font-size: 12px; transition: 0.3s; letter-spacing: 1px;
        }
        .main-tab-link.active { color: #fff; background: rgba(255,255,255,0.05); border-bottom: 3px solid var(--cyan); }

        .sub-tabs { display: flex; gap: 5px; padding: 10px 10px 0 10px; }
        .sub-tab-link {
            flex: 1; padding: 8px; background: #222; border: 1px solid #444; color: #888;
            cursor: pointer; font-size: 10px; font-weight: 700;
            text-transform: uppercase; border-radius: 4px; transition: 0.2s;
        }
        .sub-tab-link.active { background: var(--cyan); color: #000; border-color: var(--cyan); }

        .section-content { padding: 15px; display: none; flex-direction: column; gap: 15px; }
        .section-content.show { display: flex; }

        .control-group { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; border: 1px solid var(--border); }
        .control-label {
            font-size: 10px; text-transform: uppercase; color: var(--cyan);
            margin-bottom: 8px; font-weight: 700; display: block; letter-spacing: 1px;
        }
        .anim-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        input[type="checkbox"] { accent-color: var(--cyan); transform: scale(1.2); cursor: pointer; }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 5px 0; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
            background: var(--cyan); margin-top: -4px; cursor: pointer; border: 1px solid #fff;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.1); border-radius: 2px;
        }
        
        /* --- –°–¶–ï–ù–ê (PREVIEW) --- */
        .stage {
            flex: 1; position: relative; background-color: #000;
            background-size: cover; background-position: center; display: flex; flex-direction: column;
            justify-content: space-between; overflow: hidden;
        }
        .stage-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.2); z-index: 1; pointer-events: none; }
        
        .preview-hud {
            padding: 20px; z-index: 5; display: flex; justify-content: space-between;
            width: 100%; align-items: flex-start;
        }
        .hp-bar-wrap { width: 150px; }
        .hp-label { font-size: 12px; font-weight: 900; color: #fff; text-shadow: 1px 1px 0 #000; margin-bottom: 3px; display: block; }
        .hp-track { width: 100%; height: 10px; background: #333; border: 1px solid #fff; border-radius: 2px; overflow: hidden; }
        .hp-fill { height: 100%; width: 100%; transition: 0.3s; }
        .timer-preview { font-size: 24px; font-weight: 900; color: #ffd700; text-shadow: 2px 2px 0 #000; }

        .battle-area {
            flex: 1; display: flex; justify-content: space-around; align-items: center; /* <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï */
            z-index: 2; position: absolute; inset: 0; /* <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï */
            padding-bottom: 150px; /* –°–¥–≤–∏–≥–∞–µ–º –≤–≤–µ—Ä—Ö, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å –ø–∞–Ω–µ–ª—å –≤–æ–ø—Ä–æ—Å–æ–≤ */
        }
        .char-box { width: 300px; height: 350px; display: flex; align-items: flex-end; justify-content: center; }
        .char-img { max-width: 100%; max-height: 100%; object-fit: contain; transition: 0.3s; }

        .quest-dock {
            position: absolute; bottom: 0; left: 0; right: 0; background: rgba(20, 20, 30, 0.95);
            border-top: 3px solid var(--cyan); padding: 15px; z-index: 10;
            min-height: 120px; display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .q-preview-text { color: #fff; font-size: 18px; font-weight: 700; text-align: center; }
        .q-preview-btns { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .q-dummy-btn { background: #444; color: #fff; padding: 8px 20px; border: 2px solid #666; border-radius: 5px; font-weight: 700; font-size: 12px; }
        
        /* --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ó–∞–¥–∞–Ω–∏—è–º–∏ --- */
        .quest-list-item {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; border: 1px solid var(--border);
        }
        .quest-list-text { font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .quest-list-actions button { font-size: 10px; padding: 4px 6px; margin-left: 4px; }
        #quest-editor-panel { display: none; }
        
        /* --- –ü–ê–ù–ï–õ–¨ –ì–ï–ù–ï–†–ê–¶–ò–ò --- */
        .gen-panel {
            padding: 15px; border-top: 2px solid var(--border); background: #000;
        }
        .btn-generate {
            background: var(--green); color: #000; padding: 12px 25px;
            width: 100%; font-size: 14px; font-family: 'Rajdhani', sans-serif; font-weight: 700;
            text-transform: uppercase; border: none; border-radius: 6px; cursor: pointer;
            box-shadow: 0 0 10px var(--green); transition: 0.3s;
        }
        .btn-generate:hover { box-shadow: 0 0 30px var(--green); }
        
        #hidden_code { opacity: 0; position: absolute; pointer-events: none; }
        
        @keyframes fx-shake { 0%{transform: translate(1px, 1px)} 20%{transform: translate(-3px, 0px)} 40%{transform: translate(1px, -1px)} 60%{transform: translate(-3px, 1px)} 80%{transform: translate(-1px, -1px)} 100%{transform: translate(1px, -2px)} }
    </style>

    <!-- –†–ï–î–ê–ö–¢–û–† -->
    <div class="view-editor">
        <!-- –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø -->
        <div class="sidebar">
            <div class="sidebar-content">
                <div class="main-tabs">
                    <button class="main-tab-link active" onclick="app.setMainTab('chars')" id="tab_chars">–ü–ï–†–°–û–ù–ê–ñ–ò</button>
                    <button class="main-tab-link" onclick="app.setMainTab('quests')" id="tab_quests">–ó–ê–î–ê–ù–ò–Ø</button>
                </div>

                <!-- –†–ê–ó–î–ï–õ: –ü–ï–†–°–û–ù–ê–ñ–ò -->
                <div class="section-content show" id="sec_chars">
                    <div class="sub-tabs">
                        <button class="sub-tab-link active" onclick="app.setCharTab('hero')" id="st_hero">–ì–ï–†–û–ô</button>
                        <button class="sub-tab-link" onclick="app.setCharTab('boss')" id="st_boss">–ë–û–°–°</button>
                    </div>
                    <div id="cfg_hero">
                        <div class="control-group"><span class="control-label">–ò–º—è –ì–µ—Ä–æ—è</span><input type="text" class="fx-input" id="i_h_name" value="–°—Ç—É–¥–µ–Ω—Ç"><button class="fx-btn" style="width:100%" onclick="document.getElementById('f_hero').click()" id="b_h_up">–ó–ê–ì–†–£–ó–ò–¢–¨</button><input type="file" id="f_hero" hidden accept="image/*"><input type="text" class="fx-input" id="u_hero" placeholder="–°—Å—ã–ª–∫–∞..." style="margin-top:5px"></div>
                        <div class="control-group"><span class="control-label">–ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–∫–æ—è</span><div class="anim-grid" id="ag_hero"></div></div>
                        <div class="control-group"><span class="control-label">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</span><div class="toggle-row"><label style="font-size:9px; color:#aaa;">–†–∞–∑–º–µ—Ä</label><input type="range" id="r_h_size" min="50" max="150" value="100" style="width:60%"></div><div class="toggle-row"><label style="font-size:9px; color:#aaa;">–ó–¥–æ—Ä–æ–≤—å–µ (HP)</label><input type="number" class="fx-input" id="i_h_hp" value="3" style="width:50px; text-align:center;"></div><div style="display:flex; gap:5px; margin-top:5px; align-items:center;"><label style="font-size:9px; color:#aaa;">–°–≤–µ—á–µ–Ω–∏–µ:</label><input type="color" id="c_h_glow" value="#00e5ff" style="border:none; width:20px; height:20px; background:none; padding:0;"><input type="range" id="r_h_glow" min="0" max="50" value="0"></div></div>
                    </div>
                    <div id="cfg_boss" style="display:none;">
                         <div class="control-group"><span class="control-label">–ò–º—è –ë–æ—Å—Å–∞</span><input type="text" class="fx-input" id="i_b_name" value="–ü–†–û–§–ï–°–°–û–†"><button class="fx-btn" style="width:100%" onclick="document.getElementById('f_boss').click()" id="b_b_up">–ó–ê–ì–†–£–ó–ò–¢–¨</button><input type="file" id="f_boss" hidden accept="image/*"><input type="text" class="fx-input" id="u_boss" placeholder="–°—Å—ã–ª–∫–∞..." style="margin-top:5px"></div>
                        <div class="control-group"><span class="control-label">–ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–∫–æ—è</span><div class="anim-grid" id="ag_boss"></div></div>
                        <div class="control-group"><span class="control-label">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</span><div class="toggle-row"><label style="font-size:9px; color:#aaa;">–†–∞–∑–º–µ—Ä</label><input type="range" id="r_b_size" min="50" max="150" value="100" style="width:60%"></div><div class="toggle-row"><label style="font-size:9px; color:#aaa;">–ó–¥–æ—Ä–æ–≤—å–µ (HP)</label><input type="number" class="fx-input" id="i_b_hp" value="5" style="width:50px; text-align:center;"></div><div style="display:flex; gap:5px; margin-top:5px; align-items:center;"><label style="font-size:9px; color:#aaa;">–°–≤–µ—á–µ–Ω–∏–µ:</label><input type="color" id="c_b_glow" value="#ff0055" style="border:none; width:20px; height:20px; background:none; padding:0;"><input type="range" id="r_b_glow" min="0" max="50" value="0"></div></div>
                    </div>
                </div>

                <!-- –†–ê–ó–î–ï–õ: –ó–ê–î–ê–ù–ò–Ø -->
                <div class="section-content" id="sec_quests">
                    <div class="control-group"><span class="control-label">–§–æ–Ω –∏–≥—Ä—ã</span><button class="fx-btn" style="width:100%" onclick="document.getElementById('f_bg').click()" id="b_bg_up">–ó–ê–ì–†–£–ó–ò–¢–¨ –§–û–ù</button><input type="file" id="f_bg" hidden accept="image/*"></div>
                    <div class="control-group"><div class="toggle-row"><span class="control-label" style="margin:0">–¢–∞–π–º–µ—Ä (–º–∏–Ω)</span><input type="checkbox" id="chk_timer" checked></div><input type="range" id="r_timer" min="1" max="30" value="5"><div style="text-align:right; font-size:10px; color:var(--cyan);"><span id="val_timer">5</span> –º–∏–Ω</div></div>
                    <div class="control-group"><span class="control-label">–¢–µ–∫—Å—Ç—ã –∏–≥—Ä—ã</span><label style="font-size:9px; color:#888;">–ü–æ–±–µ–¥–∞:</label><input type="text" class="fx-input" id="i_win_msg" value="–ü–û–ë–ï–î–ê!"><label style="font-size:9px; color:#888;">–ü–æ—Ä–∞–∂–µ–Ω–∏–µ:</label><input type="text" class="fx-input" id="i_lose_msg" value="–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê"></div>
                    
                    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è–º–∏ -->
                    <div id="quest-list-container">
                        <div class="control-group">
                            <span class="control-label">–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π</span>
                            <div id="quest-list" style="display:flex; flex-direction:column; gap:5px; margin-bottom:10px;"></div>
                            <button class="fx-btn" style="width:100%" onclick="app.addQuest()">+ –î–û–ë–ê–í–ò–¢–¨ –ó–ê–î–ê–ù–ò–ï</button>
                        </div>
                    </div>

                    <!-- –†–µ–¥–∞–∫—Ç–æ—Ä –∑–∞–¥–∞–Ω–∏—è (—Å–∫—Ä—ã—Ç) -->
                    <div id="quest-editor-panel">
                        <div class="control-group">
                            <span class="control-label" id="editor-title">–†–ï–î–ê–ö–¢–û–† –ó–ê–î–ê–ù–ò–Ø</span>
                            <div class="sub-tabs" style="padding:0; margin-bottom:10px;">
                                <button class="sub-tab-link active" onclick="app.setQType('choice')" id="b_choice">–í–´–ë–û–†</button>
                                <button class="sub-tab-link" onclick="app.setQType('input')" id="b_input">–í–í–û–î</button>
                            </div>
                            <span class="control-label">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</span><textarea class="fx-textarea" id="i_q_text" rows="2"></textarea>
                            <div id="area_choice">
                                <span class="control-label" style="color:var(--green)">–í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç</span><input type="text" class="fx-input" id="i_c_ans">
                                <span class="control-label" style="color:var(--pink)">–ù–µ–≤–µ—Ä–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</span><input type="text" class="fx-input" id="i_w1"><input type="text" class="fx-input" id="i_w2">
                            </div>
                            <div id="area_input" style="display:none">
                                <span class="control-label" style="color:var(--green)">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç</span><input type="text" class="fx-input" id="i_in_ans">
                                <div style="font-size:9px; color:#666; margin-top:2px;">* –†–µ–≥–∏—Å—Ç—Ä –Ω–µ –≤–∞–∂–µ–Ω</div>
                            </div>
                             <button class="fx-btn" style="width:100%; margin-top:10px; background:var(--green); color:#000; border-color:var(--green)" onclick="app.saveQuest()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- –ü–ê–ù–ï–õ–¨ –ì–ï–ù–ï–†–ê–¶–ò–ò –ö–û–î–ê -->
            <div class="gen-panel">
                <button class="btn-generate" onclick="app.generate()" id="b_gen">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î</button>
            </div>
        </div>

        <!-- –°–¶–ï–ù–ê (–ü–†–ï–í–¨–Æ) -->
        <div class="stage" id="stage_bg">
            <div class="stage-overlay"></div>
            <div class="preview-hud">
                <div class="hp-bar-wrap"><span class="hp-label" id="p_h_name"></span><div class="hp-track"><div class="hp-fill" style="background:#00ff88; width:100%"></div></div></div>
                <div class="timer-preview" id="p_timer"></div>
                <div class="hp-bar-wrap" style="text-align:right"><span class="hp-label" id="p_b_name"></span><div class="hp-track"><div class="hp-fill" style="background:#ff0055; width:100%"></div></div></div>
            </div>
            <div class="battle-area">
                <div class="char-box" id="box_hero"><img src="" class="char-img" id="img_hero"></div>
                <div class="char-box" id="box_boss"><img src="" class="char-img" id="img_boss"></div>
            </div>
            <div class="quest-dock">
                <div class="q-preview-text" id="prev_q_text">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è –≤ –ø–∞–Ω–µ–ª–∏ —Å–ª–µ–≤–∞</div>
                <div class="q-preview-btns" id="prev_q_btns"></div>
            </div>
        </div>
        <textarea id="hidden_code"></textarea>
    </div>

    <script>
        const app = {
            currentQuestIndex: -1,
            quests: [],
            data: {
                hero: { src: 'https://cdn.pixabay.com/photo/2023/11/10/14/30/boy-8379435_1280.png', anim: 'idle', size: 100, hp: 3, gC: '#00e5ff', gP: 0 },
                boss: { src: 'https://cdn.pixabay.com/photo/2024/02/21/15/34/ai-generated-8587967_1280.png', anim: 'idle', size: 100, hp: 3, gC: '#ff0055', gP: 0 },
                bg: '', timer: 5, timerOn: true
            },
            anims: [
                { id: 'idle', name: '–ü–æ–∫–æ–π' }, { id: 'float', name: '–ü–∞—Ä–µ–Ω–∏–µ' }, { id: 'pulse', name: '–ü—É–ª—å—Å' },
                { id: 'shake', name: '–¢—Ä—è—Å–∫–∞' }, { id: 'glitch', name: '–ì–ª—é–∫' }, { id: 'spin', name: '–í—Ä–∞—â–µ–Ω–∏–µ' },
                { id: 'neon', name: '–ù–µ–æ–Ω' }, { id: 'wobble', name: '–®–∞—Ç–∞–Ω–∏–µ' }, { id: 'swing', name: '–ö–∞—á–∞–Ω–∏–µ' },
                { id: 'bounce', name: '–ü—Ä—ã–∂–æ–∫' }, { id: 'flip', name: '–ü–µ—Ä–µ–≤–æ—Ä–æ—Ç' }, { id: 'ghost', name: '–ü—Ä–∏–∑—Ä–∞–∫' }
            ],

            init() {
                this.renderAnims('hero'); this.renderAnims('boss'); this.bindEvents();
                if (this.quests.length === 0) {
                    this.addQuest(true); // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                } else {
                    this.renderQuestList();
                }
                this.updatePreview();
            },
            
            setMainTab(t) {
                document.querySelectorAll('.main-tab-link').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.section-content').forEach(el => el.classList.remove('show'));
                document.getElementById('tab_' + t).classList.add('active'); document.getElementById('sec_' + t).classList.add('show');
            },
            setCharTab(t) {
                document.querySelectorAll('.sub-tab-link').forEach(el => el.classList.remove('active'));
                document.getElementById('cfg_hero').style.display = 'none'; document.getElementById('cfg_boss').style.display = 'none';
                document.getElementById('st_' + t).classList.add('active'); document.getElementById('cfg_' + t).style.display = 'block';
            },
            setQType(t) {
                document.querySelector('#quest-editor-panel #b_choice').className = t==='choice'?'sub-tab-link active':'sub-tab-link';
                document.querySelector('#quest-editor-panel #b_input').className = t==='input'?'sub-tab-link active':'sub-tab-link';
                document.querySelector('#quest-editor-panel #area_choice').style.display = t==='choice'?'block':'none';
                document.querySelector('#quest-editor-panel #area_input').style.display = t==='input'?'block':'none';
            },
            renderAnims(target) {
                const grid = document.getElementById('ag_'+target); grid.innerHTML = '';
                this.anims.forEach(a => {
                    const b = document.createElement('div');
                    b.className = 'fx-btn' + (this.data[target].anim === a.id ? ' active' : '');
                    b.innerText = a.name; b.onclick = () => { this.data[target].anim = a.id; this.renderAnims(target); this.updatePreview(); };
                    grid.appendChild(b);
                });
            },
            handleImage(file, target, isBg = false) { if(file){ const r = new FileReader(); r.onload=(e)=>{if(isBg){this.data.bg=e.target.result;document.getElementById('b_bg_up').classList.add('upload-success');}else{this.data[target].src=e.target.result;document.getElementById(target==='hero'?'b_h_up':'b_b_up').classList.add('upload-success');}this.updatePreview();};r.readAsDataURL(file);}},
            bindEvents() {
                document.getElementById('f_hero').onchange=(e)=>this.handleImage(e.target.files[0],'hero');document.getElementById('f_boss').onchange=(e)=>this.handleImage(e.target.files[0],'boss');document.getElementById('f_bg').onchange=(e)=>this.handleImage(e.target.files[0],null,true);
                ['hero','boss'].forEach(t=>{document.getElementById('u_'+t).oninput=(e)=>{if(e.target.value){this.data[t].src=e.target.value;this.updatePreview();}};document.getElementById('i_'+t.charAt(0)+'_name').oninput=()=>this.updatePreview();});
                const bindS=(id,target,key)=>document.getElementById(id).oninput=(e)=>{this.data[target][key]=e.target.value;this.updatePreview();};
                bindS('r_h_size','hero','size');bindS('r_b_size','boss','size');bindS('r_h_glow','hero','gP');bindS('r_b_glow','boss','gP');bindS('i_h_hp','hero','hp');bindS('i_b_hp','boss','hp');
                document.getElementById('c_h_glow').oninput=(e)=>{this.data.hero.gC=e.target.value;this.updatePreview();};document.getElementById('c_b_glow').oninput=(e)=>{this.data.boss.gC=e.target.value;this.updatePreview();};
                document.getElementById('chk_timer').onchange=(e)=>{this.data.timerOn=e.target.checked;this.updatePreview();};
                document.getElementById('r_timer').oninput=(e)=>{this.data.timer=e.target.value;document.getElementById('val_timer').innerText=e.target.value;this.updatePreview();};
            },
            
            // --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ó–ê–î–ê–ù–ò–ô ---
            renderQuestList() {
                const list = document.getElementById('quest-list'); list.innerHTML = '';
                this.quests.forEach((q, i) => {
                    const item = document.createElement('div'); item.className = 'quest-list-item';
                    item.innerHTML = `<span class="quest-list-text">${i+1}. ${q.text || '–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å'}</span>
                    <div class="quest-list-actions">
                        <button class="fx-btn" onclick="app.editQuest(${i})">‚úèÔ∏è</button>
                        <button class="fx-btn" style="color:var(--pink)" onclick="app.deleteQuest(${i})">üóëÔ∏è</button>
                    </div>`;
                    list.appendChild(item);
                });
                this.updatePreview();
            },
            addQuest(isFirst = false) {
                const newQuest = { type: 'choice', text: '–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 2 + 2?', correct: '4', wrongs: ['5', '22'], correctInp: '4' };
                this.quests.push(newQuest);
                this.editQuest(this.quests.length - 1);
                if (!isFirst) this.renderQuestList();
            },
            editQuest(index) {
                this.currentQuestIndex = index;
                const q = this.quests[index];
                document.getElementById('editor-title').innerText = `–†–ï–î–ê–ö–¢–û–† –ó–ê–î–ê–ù–ò–Ø #${index + 1}`;
                this.setQType(q.type);
                document.getElementById('i_q_text').value = q.text;
                document.getElementById('i_c_ans').value = q.wrongs ? q.correct : '';
                document.getElementById('i_w1').value = q.wrongs ? q.wrongs[0] : '';
                document.getElementById('i_w2').value = q.wrongs ? q.wrongs[1] : '';
                document.getElementById('i_in_ans').value = q.correctInp;
                
                document.getElementById('quest-list-container').style.display = 'none';
                document.getElementById('quest-editor-panel').style.display = 'block';
            },
            saveQuest() {
                if (this.currentQuestIndex === -1) return;
                const q = this.quests[this.currentQuestIndex];
                q.type = document.querySelector('#quest-editor-panel .sub-tab-link.active').id === 'b_choice' ? 'choice' : 'input';
                q.text = document.getElementById('i_q_text').value;
                if (q.type === 'choice') {
                    q.correct = document.getElementById('i_c_ans').value;
                    q.wrongs = [document.getElementById('i_w1').value, document.getElementById('i_w2').value];
                } else {
                    q.correctInp = document.getElementById('i_in_ans').value;
                }
                
                document.getElementById('quest-list-container').style.display = 'block';
                document.getElementById('quest-editor-panel').style.display = 'none';
                this.renderQuestList();
            },
            deleteQuest(index) {
                if(confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ #${index + 1}?`)) {
                    this.quests.splice(index, 1);
                    this.renderQuestList();
                }
            },
            
            updatePreview() {
                const h=this.data.hero; const b=this.data.boss;
                document.getElementById('stage_bg').style.backgroundImage=this.data.bg?`url(${this.data.bg})`:'none';
                document.getElementById('p_h_name').innerText=document.getElementById('i_h_name').value;
                document.getElementById('p_b_name').innerText=document.getElementById('i_b_name').value;
                document.getElementById('p_timer').innerText=this.data.timerOn?(this.data.timer<10?'0'+this.data.timer:this.data.timer)+':00':'';
                
                const currentQ = this.quests[0] || { text: '–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è...' };
                document.getElementById('prev_q_text').innerText = currentQ.text;
                const btnsDiv = document.getElementById('prev_q_btns'); btnsDiv.innerHTML = '';
                if (this.quests.length > 0) {
                    if (currentQ.type === 'choice') {
                        btnsDiv.innerHTML = `<div class="q-dummy-btn">${currentQ.correct}</div><div class="q-dummy-btn">${currentQ.wrongs[0]}</div>` + (currentQ.wrongs[1] ? `<div class="q-dummy-btn">${currentQ.wrongs[1]}</div>` : '');
                    } else {
                        btnsDiv.innerHTML = `<input type="text" class="fx-input" style="width:120px" disabled placeholder="–û—Ç–≤–µ—Ç..."><div class="q-dummy-btn">OK</div>`;
                    }
                }
                
                const apply=(elId,d)=>{const img=document.getElementById(elId);img.src=d.src;img.parentNode.style.width=(d.size*0.4)+'%';const filter=d.gP>0?`drop-shadow(0 0 ${d.gP}px ${d.gC})`:'none';img.style.filter=filter;let dur=2;if(['shake','wobble'].includes(d.anim))dur=0.8;if(['flip','ghost'].includes(d.anim))dur=3;let timing=d.anim==='glitch'?'steps(2)':'ease-in-out';if(['shake','spin','flip'].includes(d.anim))timing='linear';if(['bounce'].includes(d.anim))timing='ease';if(d.anim!=='none'){img.style.animation=`fx-${d.anim} ${dur}s infinite ${timing}`;img.style.transformOrigin=d.anim==='swing'?'top center':'center';}else{img.style.animation='none';}};
                apply('img_hero', h); apply('img_boss', b);
            },

            generate() {
                const d=this.data;
                const qData={hName:document.getElementById('i_h_name').value,bName:document.getElementById('i_b_name').value,win:document.getElementById('i_win_msg').value,lose:document.getElementById('i_lose_msg').value};
                const getAnimRule=(o)=>{if(o.anim==='none')return'';let dur=2;if(['shake','wobble'].includes(o.anim))dur=0.8;if(['flip','ghost'].includes(o.anim))dur=3;let timing=o.anim==='glitch'?'steps(2)':'ease-in-out';if(['shake','spin','flip'].includes(o.anim))timing='linear';if(['bounce'].includes(o.anim))timing='ease';let origin=o.anim==='swing'?'transform-origin:top center;':'';return`animation: fx-${o.anim} ${dur}s infinite ${timing}; ${origin}`;};
                const hStyle=`width:${d.hero.size}%; filter:${d.hero.gP>0?`drop-shadow(0 0 ${d.hero.gP}px ${d.hero.gC})`:''}; ${getAnimRule(d.hero)}`;
                const bStyle=`width:${d.boss.size}%; filter:${d.boss.gP>0?`drop-shadow(0 0 ${d.boss.gP}px ${d.boss.gC})`:''}; ${getAnimRule(d.boss)}`;

                const script = `<script>
let timerVal=${d.timer*60};let timerOn=${d.timerOn};let hMax=${d.hero.hp},hCur=${d.hero.hp};let bMax=${d.boss.hp},bCur=${d.boss.hp};let audioCtx=null;
const quests = ${JSON.stringify(this.quests)};
let currentQIndex = -1;
function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();}
function beep(type){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);if(type==='win'){o.frequency.value=600;o.type='sine';g.gain.setValueAtTime(0.1,audioCtx.currentTime);o.start();o.frequency.exponentialRampToValueAtTime(1200,audioCtx.currentTime+0.1);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.3);o.stop(audioCtx.currentTime+0.3);}else{o.frequency.value=150;o.type='sawtooth';g.gain.setValueAtTime(0.1,audioCtx.currentTime);o.start();g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.4);o.stop(audioCtx.currentTime+0.4);}}
function startGame(){initAudio();document.getElementById('start-overlay').style.display='none';const c=document.getElementById('cnt-overlay');c.style.display='flex';let co=3;const i=setInterval(()=>{if(co>0){c.innerText=co;co--;}else{clearInterval(i);c.style.display='none';document.getElementById('game-root').style.opacity='1';if(timerOn)startTimer();loadNextQuestion();}},1000);}
function startTimer(){const e=document.getElementById('timer-disp');const i=setInterval(()=>{timerVal--;let m=Math.floor(timerVal/60);let s=timerVal%60;e.innerText=m+':'+(s<10?'0'+s:s);if(timerVal<=0){clearInterval(i);endGame(false);}},1000);}
function updateBars(){document.getElementById('bar-h').style.width=((hCur/hMax)*100)+'%';document.getElementById('bar-b').style.width=((bCur/bMax)*100)+'%';}
function loadNextQuestion(){currentQIndex++;if(currentQIndex>=quests.length){if(bCur>0)endGame(false);return;}const q=quests[currentQIndex];document.getElementById('q-text').innerText=q.text;const p=document.getElementById('q-inputs');let html='';if(q.type==='choice'){const ans=[{t:q.correct,c:true}];q.wrongs.forEach(w=>{if(w)ans.push({t:w,c:false});});ans.sort(()=>Math.random()-0.5);html=\`<div class="btns">\${ans.map(a=>\`<button class="game-btn" onclick="checkChoice(this, \${a.c})">\${a.t}</button>\`).join('')}</div>\`;}else{html=\`<div class="inp-area"><input type="text" id="inp-ans" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..."><button class="game-btn" onclick="checkInput()">–û–ö</button></div>\`;}p.innerHTML=html;}
function checkChoice(b,isCor){if(isCor){handleCorrect(b);}else{handleWrong(b);}}
function checkInput(){const i=document.getElementById('inp-ans');const val=i.value.trim().toLowerCase();const cor=quests[currentQIndex].correctInp.trim().toLowerCase();if(val===cor){handleCorrect(i);}else{handleWrong(i);}}
function handleCorrect(el){beep('win');bCur--;updateBars();if(el.tagName==='BUTTON'){el.style.background='#00ff88';el.style.color='#000';}else{el.style.borderColor='#00ff88';}document.getElementById('boss-img').style.animation='fx-shake 0.5s linear';setTimeout(()=>{if(!checkWin())loadNextQuestion();},1000);}
function handleWrong(el){beep('fail');hCur--;updateBars();if(el.tagName==='BUTTON'){el.style.background='#ff0055';}else{el.style.borderColor='#ff0055';}document.getElementById('hero-img').style.animation='fx-shake 0.5s linear';setTimeout(()=>{checkWin();},1000);}
function checkWin(){const hAnim='${getAnimRule(d.hero)}';const bAnim='${getAnimRule(d.boss)}';document.getElementById('hero-img').style.animation=hAnim;document.getElementById('boss-img').style.animation=bAnim;if(bCur<=0){endGame(true);return true;}if(hCur<=0){endGame(false);return true;}return false;}
function endGame(win){document.getElementById('timer-disp').style.display='none';const p=document.getElementById('q-panel');p.innerHTML="";if(win){document.getElementById('boss-img').style.opacity='0';document.getElementById('hero-img').style.animation='fx-bounce 0.5s ease infinite';p.innerHTML="<h2 style='color:#00ff88;font-size:40px;text-shadow:0 0 20px #00ff88'>${qData.win}</h2>";}else{document.getElementById('hero-img').style.opacity='0';p.innerHTML="<h2 style='color:#ff0055;font-size:40px;text-shadow:0 0 20px #ff0055'>${qData.lose}</h2>";}}
<\/script>`;

                const html = `<!DOCTYPE html><html><head><style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@700&family=Montserrat:wght@900&display=swap');
body{margin:0;overflow:hidden;font-family:'Rajdhani',sans-serif;user-select:none;width:100vw;height:100vh;background:#000;}
@keyframes fx-idle{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}@keyframes fx-float{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-15px) rotate(2deg)}}@keyframes fx-pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}@keyframes fx-shake{0%{transform:translate(1px, 1px)}20%{transform:translate(-3px, 0px)}40%{transform:translate(1px, -1px)}60%{transform:translate(-3px, 1px)}80%{transform:translate(-1px, -1px)}100%{transform:translate(1px, -2px)}}@keyframes fx-glitch{0%{transform:translate(0)}20%{transform:translate(-2px, 2px)}40%{transform:translate(-2px, -2px)}60%{transform:translate(2px, 2px)}80%{transform:translate(2px, -2px)}100%{transform:translate(0)}}@keyframes fx-spin{0%{transform:rotateY(0deg)}100%{transform:rotateY(360deg)}}@keyframes fx-neon{0%,100%{opacity:1;filter:brightness(1)}50%{opacity:0.8;filter:brightness(1.5)}}@keyframes fx-wobble{0%,100%{transform:rotate(0deg)}25%{transform:rotate(-5deg)}75%{transform:rotate(5deg)}}@keyframes fx-swing{0%{transform:rotate(0deg)}20%{transform:rotate(15deg)}40%{transform:rotate(-10deg)}60%{transform:rotate(5deg)}80%{transform:rotate(-5deg)}100%{transform:rotate(0deg)}}@keyframes fx-bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-30px)}60%{transform:translateY(-15px)}}@keyframes fx-flip{0%{transform:rotateY(0)}100%{transform:rotateY(360deg)}}@keyframes fx-ghost{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(1.05)}}
.scene{display:flex;flex-direction:column;height:100%;justify-content:space-between;position:relative;opacity:0;transition:1s;background:${d.bg?`url(${d.bg}) center/cover`:'transparent'};}
.overlay{position:fixed;inset:0;background:#050505;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.big-title{font-family:'Press Start 2P',cursive;font-size:40px;color:#00e5ff;text-align:center;margin-bottom:40px;text-shadow:4px 4px 0 #ff0055;line-height:1.5;}
.play-btn{background:transparent;color:#fff;padding:15px 50px;border:2px solid #fff;border-radius:50px;font-size:24px;font-weight:900;cursor:pointer;transition:0.3s;animation:fx-pulse 2s infinite;}
.play-btn:hover{background:#00e5ff;color:#000;border-color:#00e5ff;box-shadow:0 0 30px #00e5ff;}
.count-num{font-size:150px;font-weight:900;color:#fff;animation:fx-pulse 0.5s infinite;}
.hud{padding:20px;display:flex;justify-content:space-between;z-index:10;width:100%;align-items:flex-start;}
.hp-wrap{width:200px;}.hp-name{color:#fff;font-weight:900;font-size:14px;margin-bottom:5px;display:block;text-shadow:2px 2px 0 #000;}
.hp-track{width:100%;height:12px;background:rgba(0,0,0,0.8);border:2px solid #fff;border-radius:4px;overflow:hidden;}
.hp-fill{height:100%;transition:0.5s cubic-bezier(0.4,0.0,0.2,1);}.timer{color:#ffd700;font-size:30px;font-weight:900;text-shadow:3px 3px 0 #000;}
.stage{flex:1;display:flex;justify-content:space-between;align-items:center;padding:0 10%;perspective:1000px;position:absolute;inset:0;padding-bottom:180px;} /* <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï */
.char-wrap{width:40%;height:85%;display:flex;align-items:flex-end;justify-content:center;}
.char{max-width:100%;max-height:100%;object-fit:contain;transition:0.5s;}
.ui-panel{position:absolute;bottom:0;left:0;right:0;background:rgba(20,20,30,0.95);padding:20px;border-top:4px solid #00e5ff;display:flex;flex-direction:column;align-items:center;gap:15px;min-height:180px;box-shadow:0 -10px 50px rgba(0,0,0,0.5); z-index: 20;}
.q-text{color:#fff;font-size:24px;font-weight:700;text-align:center;font-family:'Montserrat',sans-serif;}
.btns{display:flex;gap:15px;flex-wrap:wrap;justify-content:center;width:100%;}
.game-btn{background:#444;border:2px solid #666;color:#fff;padding:15px 30px;font-family:inherit;font-weight:700;font-size:18px;cursor:pointer;text-transform:uppercase;border-radius:8px;transition:0.1s;min-width:150px;}
.game-btn:hover{background:#666;border-color:#fff;transform:translateY(-2px);}.inp-area{display:flex;gap:10px;}
input[type=text]{padding:15px;border-radius:6px;border:2px solid #fff;font-family:inherit;font-weight:700;background:#000;color:#fff;font-size:18px;outline:none;}
</style></head><body>
<div class="overlay" id="start-overlay"><div class="big-title">–ë–ò–¢–í–ê<br>–° –ë–û–°–°–û–ú</div><button class="play-btn" onclick="startGame()">–ò–ì–†–ê–¢–¨</button></div>
<div class="overlay" id="cnt-overlay" style="display:none;background:rgba(0,0,0,0.8)"><div class="count-num">3</div></div>
<div class="scene" id="game-root">
<div class="hud"><div class="hp-wrap"><span class="hp-name">${qData.hName}</span><div class="hp-track"><div class="hp-fill" id="bar-h" style="background:#00ff88;width:100%"></div></div></div><div class="timer" id="timer-disp">${d.timerOn?(d.timer<10?'0'+d.timer:d.timer)+':00':''}</div><div class="hp-wrap" style="text-align:right"><span class="hp-name">${qData.bName}</span><div class="hp-track"><div class="hp-fill" id="bar-b" style="background:#ff0055;width:100%"></div></div></div></div>
<div class="stage"><div class="char-wrap"><img src="${d.hero.src}" class="char" id="hero-img" style="${hStyle}"></div><div class="char-wrap"><img src="${d.boss.src}" class="char" id="boss-img" style="${bStyle}"></div></div>
<div class="ui-panel" id="q-panel"><div class="q-text" id="q-text"></div><div id="q-inputs"></div></div>
</div>${script}</body></html>`;

                const area = document.getElementById('hidden_code');
                area.value = `<iframe srcdoc="${html.replace(/"/g, '&quot;')}" width="100%" height="100%" frameborder="0" style="background:transparent; display:block"></iframe>`;
                area.select(); document.execCommand('copy');
                const btn = document.getElementById('b_gen'); const old = btn.innerText;
                btn.innerText = "–ì–û–¢–û–í–û!"; btn.style.background = "#fff";
                setTimeout(() => { btn.innerText = old; btn.style.background = ""; }, 1500);
            }
        };
        app.init();
    </script>
</div>
