<div id="FX_ROOT">
    <style>
        /* --- –®–†–ò–§–¢–´ --- */
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Montserrat:wght@400;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        /* --- –ù–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï (CYBERPUNK THEME) --- */
        #FX_ROOT {
            --bg-dark: #0A0912;
            --bg-panel: #12101E;
            --primary: #8A2BE2; /* Violet */
            --cyan: #00D2FF;
            --green: #00FF88;
            --text: #EAEAEA;
            --border: rgba(138, 43, 226, 0.3);
            --input-bg: #0A0912;
            width: 100%; height: 100%;
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-dark); color: var(--text);
            overflow: hidden; position: relative; display: flex;
        }
        #FX_ROOT * { box-sizing: border-box; user-select: none; outline: none; }
        
        /* --- UI –≠–õ–ï–ú–ï–ù–¢–´ (REDESIGN) --- */
        .fx-btn { background: rgba(138, 43, 226, 0.1); border: 1px solid var(--border); color: var(--cyan); padding: 8px; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-weight: 700; text-transform: uppercase; transition: 0.2s; border-radius: 6px; font-size: 11px; text-align: center; }
        .fx-btn:hover { border-color: var(--primary); color: #fff; background: rgba(138, 43, 226, 0.3); }
        .fx-btn.active { background: var(--cyan); color: #000; border-color: var(--cyan); box-shadow: 0 0 10px rgba(0, 210, 255, 0.5); }
        .fx-input, .fx-textarea { background: var(--input-bg); border: 1px solid var(--border); color: #fff; padding: 10px; width: 100%; font-size: 12px; border-radius: 6px; font-family: monospace; transition: 0.3s; margin-bottom: 5px; }
        .fx-input:focus, .fx-textarea:focus { border-color: var(--cyan); box-shadow: 0 0 8px rgba(0, 210, 255, 0.3); }
        
        .view-editor { flex: 1; display: flex; opacity: 1; pointer-events: auto; }
        .sidebar { width: 350px; background: var(--bg-panel); border-right: 2px solid #000; display: flex; flex-direction: column; z-index: 10; box-shadow: 5px 0 25px rgba(0,0,0,0.5); }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; }
        #FX_ROOT .sidebar-content::-webkit-scrollbar { width: 4px; } #FX_ROOT .sidebar-content::-webkit-scrollbar-track { background: #000; } #FX_ROOT .sidebar-content::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 2px; }
        .main-tabs { display: flex; border-bottom: 2px solid #000; margin: -15px -15px 15px -15px; }
        .main-tab-link { flex: 1; padding: 15px 5px; text-align: center; background: transparent; border: none; color: #888; font-weight: 900; text-transform: uppercase; cursor: pointer; font-size: 12px; transition: 0.3s; letter-spacing: 1px; border-bottom: 3px solid transparent; }
        .main-tab-link.active { color: #fff; border-bottom: 3px solid var(--cyan); }
        .sub-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .sub-tab-link { flex: 1; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); color: #888; cursor: pointer; font-size: 10px; font-weight: 700; text-transform: uppercase; border-radius: 6px; transition: 0.2s; }
        .sub-tab-link.active { background: var(--cyan); color: #000; border-color: var(--cyan); }
        .section-content { display: none; flex-direction: column; gap: 15px; }
        .section-content.show { display: flex; }
        .control-group { background: transparent; padding: 10px; border-radius: 8px; border: 1px solid var(--border); }
        .control-label { font-size: 10px; text-transform: uppercase; color: var(--cyan); margin-bottom: 8px; font-weight: 700; display: block; letter-spacing: 1px; }
        .anim-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 5px 0; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: var(--cyan); margin-top: -5px; cursor: pointer; border: 2px solid #fff; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(0,0,0,0.5); border-radius: 2px; border: 1px solid var(--border); }
        .param-row { display: flex; align-items: center; justify-content: space-between; font-size: 11px; color: #aaa; margin-bottom: 5px; }
        
        .stage { flex: 1; position: relative; background-color: #222222; background-size: cover; background-position: center; display: flex; flex-direction: column; justify-content: space-between; overflow: hidden; }
        
        .preview-hud { padding: 20px; z-index: 5; display: flex; justify-content: space-between; width: 100%; align-items: center; }
        .hud-player { display: flex; align-items: center; gap: 10px; }
        .hud-player.right { flex-direction: row-reverse; }
        .hp-bar-preview { width: 150px; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; border: 1px solid #444; overflow: hidden; }
        .hp-fill-preview { height: 100%; transition: 0.3s; }
        .hud-char-name { font-size: 16px; font-weight: 900; color: #fff; text-shadow: 1px 1px 0 #000; }
        .timer-preview { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 28px; background: rgba(0,0,0,0.5); color: #ffd700; padding: 2px 12px; border-radius: 6px; letter-spacing: 2px; border: 1px solid rgba(255,255,255,0.2); }

        .battle-area { flex: 1; display: flex; justify-content: space-around; align-items: center; z-index: 2; position: absolute; inset: 0; padding-bottom: 150px; }
        .char-box { width: 300px; height: 350px; display: flex; align-items: flex-end; justify-content: center; }
        .char-img { max-width: 100%; max-height: 100%; object-fit: contain; transition: 0.3s; }

        .quest-dock { position: absolute; bottom: 0; left: 0; right: 0; background: var(--bg-panel); border-top: 3px solid var(--cyan); padding: 15px; z-index: 10; min-height: 120px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .q-preview-text { color: #fff; font-size: 18px; font-weight: 700; text-align: center; }
        .q-preview-btns { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .q-dummy-btn { background: #333; color: #fff; padding: 8px 20px; border: 2px solid #555; border-radius: 5px; font-weight: 700; font-size: 12px; }
        
        #quest-editor-panel, #location-list { display: none; }
        .list-item { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; border: 1px solid var(--border); font-size: 11px; }
        .list-item button { font-size: 10px; padding: 4px 6px; margin-left: 4px; }
        
        .gen-panel { padding: 15px; border-top: 2px solid #000; background: var(--bg-panel); }
        .btn-generate { background: var(--green); color: #000; padding: 12px 25px; width: 100%; font-size: 14px; font-family: 'Rajdhani', sans-serif; font-weight: 700; text-transform: uppercase; border: none; border-radius: 6px; cursor: pointer; box-shadow: 0 0 15px var(--green); transition: 0.3s; }
        .btn-generate:hover { box-shadow: 0 0 30px var(--green); filter: brightness(1.2); }
        
        @keyframes fx-idle{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}@keyframes fx-float{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-15px) rotate(2deg)}}@keyframes fx-pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}@keyframes fx-shake{0%{transform:translate(1px, 1px)}20%{transform:translate(-3px, 0px)}40%{transform:translate(1px, -1px)}60%{transform:translate(-3px, 1px)}80%{transform:translate(-1px, -1px)}100%{transform:translate(1px, -2px)}}@keyframes fx-glitch{0%{transform:translate(0)}20%{transform:translate(-2px, 2px)}40%{transform:translate(-2px, -2px)}60%{transform:translate(2px, 2px)}80%{transform:translate(2px, -2px)}100%{transform:translate(0)}}@keyframes fx-spin{0%{transform:rotateY(0deg)}100%{transform:rotateY(360deg)}}@keyframes fx-neon{0%,100%{opacity:1;filter:brightness(1)}50%{opacity:0.8;filter:brightness(1.5)}}@keyframes fx-wobble{0%,100%{transform:rotate(0deg)}25%{transform:rotate(-5deg)}75%{transform:rotate(5deg)}}@keyframes fx-swing{0%{transform:rotate(0deg)}20%{transform:rotate(15deg)}40%{transform:rotate(-10deg)}60%{transform:rotate(5deg)}80%{transform:rotate(-5deg)}100%{transform:rotate(0deg)}}@keyframes fx-bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-30px)}60%{transform:translateY(-15px)}}@keyframes fx-flip{0%{transform:rotateY(0deg)}100%{transform:rotateY(360deg)}}@keyframes fx-ghost{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(1.05)}}
    </style>

    <div class="view-editor">
        <div class="sidebar">
            <div class="sidebar-content">
                <div class="main-tabs"><button class="main-tab-link active" onclick="app.setMainTab('chars')">–ü–ï–†–°–û–ù–ê–ñ–ò</button><button class="main-tab-link" onclick="app.setMainTab('quests')">–ó–ê–î–ê–ù–ò–Ø</button></div>
                <div class="section-content show" id="sec_chars">
                    <div class="sub-tabs"><button class="sub-tab-link active" onclick="app.setCharTab('hero')">–ì–ï–†–û–ô</button><button class="sub-tab-link" onclick="app.setCharTab('boss')">–ë–û–°–°</button></div>
                    <div id="cfg_hero">
                        <div class="control-group"><span class="control-label">–ò–º—è –ì–µ—Ä–æ—è</span><input type="text" class="fx-input" id="i_h_name" value="–ì–µ—Ä–æ–π"><button class="fx-btn" style="width:100%" onclick="document.getElementById('f_hero').click()">–ó–ê–ì–†–£–ó–ò–¢–¨</button><input type="file" id="f_hero" hidden accept="image/*"></div>
                        <div class="control-group"><span class="control-label">–ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–∫–æ—è</span><div class="anim-grid" id="ag_hero"></div></div>
                        <div class="control-group"><span class="control-label">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</span><div class="param-row"><span>–†–∞–∑–º–µ—Ä</span><input type="range" id="r_h_size" min="50" max="150" value="100" style="width:60%"></div><div class="param-row"><span>–ó–¥–æ—Ä–æ–≤—å–µ (HP)</span><input type="number" class="fx-input" id="i_h_hp" value="3" style="width:50px;padding:4px;height:auto;margin:0;"></div><div class="param-row"><span>–°–≤–µ—á–µ–Ω–∏–µ</span><input type="range" id="r_h_glow" min="0" max="50" value="0" style="width:60%"><input type="color" id="c_h_glow" value="#00e5ff" style="border:none;width:20px;height:20px;background:none;padding:0;"></div><div class="param-row"><span>–°–∫–æ—Ä–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏</span><input type="range" id="r_h_speed" min="1" max="10" value="3" style="width:60%"></div></div>
                    </div>
                    <div id="cfg_boss" style="display:none;">
                         <div class="control-group"><span class="control-label">–ò–º—è –ë–æ—Å—Å–∞</span><input type="text" class="fx-input" id="i_b_name" value="–ë–æ—Å—Å"><button class="fx-btn" style="width:100%" onclick="document.getElementById('f_boss').click()">–ó–ê–ì–†–£–ó–ò–¢–¨</button><input type="file" id="f_boss" hidden accept="image/*"></div>
                        <div class="control-group"><span class="control-label">–ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–∫–æ—è</span><div class="anim-grid" id="ag_boss"></div></div>
                        <div class="control-group"><span class="control-label">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</span><div class="param-row"><span>–†–∞–∑–º–µ—Ä</span><input type="range" id="r_b_size" min="50" max="150" value="100" style="width:60%"></div><div class="param-row"><span>–ó–¥–æ—Ä–æ–≤—å–µ (HP)</span><input type="number" class="fx-input" id="i_b_hp" value="3" style="width:50px;padding:4px;height:auto;margin:0;"></div><div class="param-row"><span>–°–≤–µ—á–µ–Ω–∏–µ</span><input type="range" id="r_b_glow" min="0" max="50" value="0" style="width:60%"><input type="color" id="c_b_glow" value="#ff0055" style="border:none;width:20px;height:20px;background:none;padding:0;"></div><div class="param-row"><span>–°–∫–æ—Ä–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏</span><input type="range" id="r_b_speed" min="1" max="10" value="3" style="width:60%"></div></div>
                    </div>
                </div>
                <div class="section-content" id="sec_quests">
                    <div class="control-group"><span class="control-label">–õ–æ–∫–∞—Ü–∏–∏ –∏ –ú—É–∑—ã–∫–∞</span><button class="fx-btn" style="width:100%" onclick="document.getElementById('f_loc').click()">+ –ó–ê–ì–†–£–ó–ò–¢–¨ –õ–û–ö–ê–¶–ò–ò</button><input type="file" id="f_loc" hidden accept="image/*" multiple><div id="location-list" style="display:flex; flex-direction:column; gap:5px; margin-top:10px;"></div><button class="fx-btn" style="width:100%; margin-top:10px;" onclick="document.getElementById('f_music').click()">–ó–ê–ì–†–£–ó–ò–¢–¨ –ú–£–ó–´–ö–£</button><input type="file" id="f_music" hidden accept="audio/*"><span id="music_name" style="font-size:10px; color:#888; text-align:center; display:block; margin-top:4px;"></span></div>
                    <div class="control-group"><div class="param-row"><span class="control-label" style="margin:0">–¢–∞–π–º–µ—Ä (–º–∏–Ω)</span><input type="checkbox" id="chk_timer" checked></div><input type="range" id="r_timer" min="1" max="30" value="5"><div style="text-align:right;font-size:10px;color:var(--cyan);"><span id="val_timer">5</span> –º–∏–Ω</div></div>
                    <div class="control-group"><span class="control-label">–¢–µ–∫—Å—Ç—ã –∏–≥—Ä—ã</span><label style="font-size:9px;color:#888;">–ü–æ–±–µ–¥–∞:</label><input type="text" class="fx-input" id="i_win_msg" value="–ü–û–ë–ï–î–ê!"><label style="font-size:9px;color:#888;">–ü–æ—Ä–∞–∂–µ–Ω–∏–µ:</label><input type="text" class="fx-input" id="i_lose_msg" value="–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê"><label style="font-size:9px;color:#888;">–ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ä—Ç:</label><input type="text" class="fx-input" id="i_play_btn" value="–ò–ì–†–ê–¢–¨"></div>
                    <div id="quest-list-container"><div class="control-group"><span class="control-label">–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π</span><div id="quest-list" style="display:flex;flex-direction:column;gap:5px;margin-bottom:10px;"></div><button class="fx-btn" style="width:100%" onclick="app.addQuest()">+ –î–û–ë–ê–í–ò–¢–¨ –ó–ê–î–ê–ù–ò–ï</button></div></div>
                    <div id="quest-editor-panel"><div class="control-group"><span class="control-label" id="editor-title">–†–ï–î–ê–ö–¢–û–†</span><div class="sub-tabs"><button class="sub-tab-link active" onclick="app.setQType('choice')" id="b_choice">–í–´–ë–û–†</button><button class="sub-tab-link" onclick="app.setQType('input')" id="b_input">–í–í–û–î</button></div><span class="control-label">–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞</span><textarea class="fx-textarea" id="i_q_text" rows="2"></textarea><div id="area_choice"><span class="control-label" style="color:var(--green)">–í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç</span><input type="text" class="fx-input" id="i_c_ans"><span class="control-label" style="color:var(--primary)">–ù–µ–≤–µ—Ä–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</span><input type="text" class="fx-input" id="i_w1"><input type="text" class="fx-input" id="i_w2"></div><div id="area_input" style="display:none"><span class="control-label" style="color:var(--green)">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç</span><input type="text" class="fx-input" id="i_in_ans"></div><button class="fx-btn" style="width:100%;margin-top:10px;background:var(--green);color:#000;border-color:var(--green)" onclick="app.saveQuest()">–°–û–•–†–ê–ù–ò–¢–¨</button></div></div>
                </div>
            </div>
            <div class="gen-panel"><button class="btn-generate" onclick="app.generate()" id="b_gen">–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –ö–û–î</button></div>
        </div>

        <div class="stage" id="stage_bg">
            <div class="preview-hud">
                <div class="hud-player"><span class="hud-char-name" id="p_h_name"></span><div class="hp-bar-preview"><div id="hp_h_preview" class="hp-fill-preview" style="background:var(--green);"></div></div></div>
                <div class="timer-preview" id="p_timer">05:00</div>
                <div class="hud-player right"><span class="hud-char-name" id="p_b_name"></span><div class="hp-bar-preview"><div id="hp_b_preview" class="hp-fill-preview" style="background:var(--primary);"></div></div></div>
            </div>
            <div class="battle-area">
                <div class="char-box"><img src="" class="char-img" id="img_hero"></div>
                <div class="char-box"><img src="" class="char-img" id="img_boss"></div>
            </div>
            <div class="quest-dock"><div class="q-preview-text" id="prev_q_text"></div><div class="q-preview-btns" id="prev_q_btns"></div></div>
        </div>
        <textarea id="hidden_code"></textarea>
    </div>

    <script>
        const app={currentQuestIndex:-1,quests:[],locations:[],musicFile:null,
        data:{hero:{src:'',anim:'idle',size:100,gC:'#00e5ff',gP:0,hp:3,speed:3},boss:{src:'',anim:'idle',size:100,gC:'#ff0055',gP:0,hp:3,speed:3},bg:'',timer:5,timerOn:true},
        anims:[{id:'idle',name:'–ü–æ–∫–æ–π'},{id:'float',name:'–ü–∞—Ä–µ–Ω–∏–µ'},{id:'pulse',name:'–ü—É–ª—å—Å'},{id:'shake',name:'–¢—Ä—è—Å–∫–∞'},{id:'glitch',name:'–ì–ª—é–∫'},{id:'spin',name:'–í—Ä–∞—â–µ–Ω–∏–µ'},{id:'neon',name:'–ù–µ–æ–Ω'},{id:'wobble',name:'–®–∞—Ç–∞–Ω–∏–µ'},{id:'swing',name:'–ö–∞—á–∞–Ω–∏–µ'},{id:'bounce',name:'–ü—Ä—ã–∂–æ–∫'},{id:'flip',name:'–ü–µ—Ä–µ–≤–æ—Ä–æ—Ç'},{id:'ghost',name:'–ü—Ä–∏–∑—Ä–∞–∫'}],
        init(){this.renderAnims('hero');this.renderAnims('boss');this.bindEvents();this.addQuest(true);this.updatePreview();},
        setMainTab(t){document.querySelectorAll('.main-tab-link').forEach(e=>e.classList.remove('active'));document.querySelector(`[onclick="app.setMainTab('${t}')"]`).classList.add('active');document.getElementById('sec_chars').classList.toggle('show',t==='chars');document.getElementById('sec_quests').classList.toggle('show',t==='quests');},
        setCharTab(t){document.querySelector('#sec_chars .sub-tab-link.active').classList.remove('active');document.querySelector(`[onclick="app.setCharTab('${t}')"]`).classList.add('active');document.getElementById('cfg_hero').style.display=t==='hero'?'block':'none';document.getElementById('cfg_boss').style.display=t==='boss'?'block':'none';},
        setQType(t){document.querySelector('#quest-editor-panel #b_choice').className=t==='choice'?'sub-tab-link active':'sub-tab-link';document.querySelector('#quest-editor-panel #b_input').className=t==='input'?'sub-tab-link active':'sub-tab-link';document.querySelector('#quest-editor-panel #area_choice').style.display=t==='choice'?'block':'none';document.querySelector('#quest-editor-panel #area_input').style.display=t==='input'?'block':'none';},
        renderAnims(target){const grid=document.getElementById('ag_'+target);grid.innerHTML='';this.anims.forEach(a=>{const b=document.createElement('div');b.className='fx-btn'+(this.data[target].anim===a.id?' active':'');b.innerText=a.name;b.onclick=()=>{this.data[target].anim=a.id;this.renderAnims(target);this.updatePreview();};grid.appendChild(b);});},
        handleImage(file,target){if(file){const r=new FileReader();r.onload=e=>{this.data[target].src=e.target.result;this.updatePreview();};r.readAsDataURL(file);}},
        handleLocations(files){for(let file of files){const r=new FileReader();r.onload=e=>{this.locations.push({name:file.name,data:e.target.result});this.renderLocationList();};r.readAsDataURL(file);}},
        renderLocationList(){const container=document.getElementById('location-list');container.innerHTML='';this.locations.forEach((loc,i)=>{const item=document.createElement('div');item.className='list-item';item.innerHTML=`<span>${i+1}. ${loc.name}</span><button class="fx-btn" style="color:var(--primary)" onclick="app.deleteLocation(${i})">X</button>`;container.appendChild(item);});container.style.display=this.locations.length>0?'flex':'none';this.updatePreview();},
        deleteLocation(index){this.locations.splice(index,1);this.renderLocationList();},
        handleMusic(file){if(file){const r=new FileReader();r.onload=e=>{this.musicFile={name:file.name,data:e.target.result};document.getElementById('music_name').textContent='–§–∞–π–ª: '+file.name;};r.readAsDataURL(file);}},
        bindEvents(){document.getElementById('f_hero').onchange=e=>this.handleImage(e.target.files[0],'hero');document.getElementById('f_boss').onchange=e=>this.handleImage(e.target.files[0],'boss');document.getElementById('f_loc').onchange=e=>this.handleLocations(e.target.files);document.getElementById('f_music').onchange=e=>this.handleMusic(e.target.files[0]);['hero','boss'].forEach(t=>{document.getElementById('i_'+t.charAt(0)+'_name').oninput=()=>this.updatePreview();});const bindS=(id,target,key)=>document.getElementById(id).oninput=e=>{this.data[target][key]=e.target.value;this.updatePreview();};bindS('r_h_size','hero','size');bindS('r_b_size','boss','size');bindS('r_h_glow','hero','gP');bindS('r_b_glow','boss','gP');bindS('i_h_hp','hero','hp');bindS('i_b_hp','boss','hp');bindS('r_h_speed','hero','speed');bindS('r_b_speed','boss','speed');document.getElementById('c_h_glow').oninput=e=>{this.data.hero.gC=e.target.value;this.updatePreview();};document.getElementById('c_b_glow').oninput=e=>{this.data.boss.gC=e.target.value;this.updatePreview();};document.getElementById('chk_timer').onchange=e=>{this.data.timerOn=e.target.checked;this.updatePreview();};document.getElementById('r_timer').oninput=e=>{this.data.timer=e.target.value;document.getElementById('val_timer').innerText=e.target.value;this.updatePreview();};},
        renderQuestList(){const list=document.getElementById('quest-list');list.innerHTML='';this.quests.forEach((q,i)=>{const item=document.createElement('div');item.className='list-item';item.innerHTML=`<span>${i+1}. ${q.text||'–ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å'}</span><div><button class="fx-btn" onclick="app.editQuest(${i})">‚úèÔ∏è</button><button class="fx-btn" style="color:var(--primary)" onclick="app.deleteQuest(${i})">üóëÔ∏è</button></div>`;list.appendChild(item);});this.updatePreview();},
        addQuest(isFirst=false){const newQ={type:'choice',text:'–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 2 + 2?',correct:'4',wrongs:['5','22'],correctInp:'4'};this.quests.push(newQ);if(!isFirst)this.renderQuestList();this.editQuest(this.quests.length-1);},
        editQuest(index){this.currentQuestIndex=index;const q=this.quests[index];document.getElementById('editor-title').innerText=`–ó–ê–î–ê–ù–ò–ï #${index+1}`;this.setQType(q.type);document.getElementById('i_q_text').value=q.text;document.getElementById('i_c_ans').value=q.correct;document.getElementById('i_w1').value=q.wrongs[0];document.getElementById('i_w2').value=q.wrongs[1];document.getElementById('i_in_ans').value=q.correctInp;document.getElementById('quest-list-container').style.display='none';document.getElementById('quest-editor-panel').style.display='block';},
        saveQuest(){if(this.currentQuestIndex===-1)return;const q=this.quests[this.currentQuestIndex];q.type=document.querySelector('#quest-editor-panel .sub-tab-link.active').id==='b_choice'?'choice':'input';q.text=document.getElementById('i_q_text').value;if(q.type==='choice'){q.correct=document.getElementById('i_c_ans').value;q.wrongs=[document.getElementById('i_w1').value,document.getElementById('i_w2').value];}else{q.correctInp=document.getElementById('i_in_ans').value;}document.getElementById('quest-list-container').style.display='block';document.getElementById('quest-editor-panel').style.display='none';this.renderQuestList();},
        deleteQuest(index){if(confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ #${index+1}?`)){this.quests.splice(index,1);this.renderQuestList();}},
        updatePreview(){const h=this.data.hero;const b=this.data.boss;document.getElementById('stage_bg').style.backgroundImage=this.locations.length>0?`url(${this.locations[0].data})`:'none';document.getElementById('p_h_name').innerText=document.getElementById('i_h_name').value;document.getElementById('p_b_name').innerText=document.getElementById('i_b_name').value;document.getElementById('p_timer').innerText=this.data.timerOn?(this.data.timer<10?'0'+this.data.timer:this.data.timer)+':00':'';document.getElementById('hp_h_preview').style.width=document.getElementById('hp_b_preview').style.width='100%';const currentQ=this.quests[0]||{text:'–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è...'};document.getElementById('prev_q_text').innerText=currentQ.text;const btnsDiv=document.getElementById('prev_q_btns');btnsDiv.innerHTML='';if(this.quests.length>0){if(currentQ.type==='choice'){btnsDiv.innerHTML=`<div class="q-dummy-btn">${currentQ.correct}</div><div class="q-dummy-btn">${currentQ.wrongs[0]}</div>`+(currentQ.wrongs[1]?`<div class="q-dummy-btn">${currentQ.wrongs[1]}</div>`:'');}else{btnsDiv.innerHTML=`<input type="text" class="fx-input" style="width:120px" disabled><div class="q-dummy-btn">OK</div>`;}}const apply=(elId,d)=>{const img=document.getElementById(elId);img.src=d.src;img.parentNode.style.width=d.size*0.4+'%';img.style.filter=d.gP>0?`drop-shadow(0 0 ${d.gP}px ${d.gC})`:'none';let dur= (11 - d.speed) * 0.5;if(['shake','wobble'].includes(d.anim))dur*=.5;let timing='ease-in-out';if(['glitch'].includes(d.anim))timing=`steps(${Math.round(dur*10)})`;if(['shake','spin','flip'].includes(d.anim))timing='linear';img.style.animation=d.anim!=='none'?`fx-${d.anim} ${dur}s infinite ${timing}`:'none';img.style.transformOrigin=d.anim==='swing'?'top center':'center';};apply('img_hero',h);apply('img_boss',b);},
        generate(){const d=this.data;const qData={hName:document.getElementById('i_h_name').value,bName:document.getElementById('i_b_name').value,win:document.getElementById('i_win_msg').value,lose:document.getElementById('i_lose_msg').value,play:document.getElementById('i_play_btn').value,};const getAnimRule=o=>{if(o.anim==='none')return'';let dur=(11-o.speed)*0.5;if(['shake','wobble'].includes(o.anim))dur*=.5;let timing='ease-in-out';if(['glitch'].includes(o.anim))timing=`steps(${Math.round(dur*10)})`;if(['shake','spin','flip'].includes(o.anim))timing='linear';return`animation:fx-${o.anim} ${dur}s infinite ${timing};transform-origin:${o.anim==='swing'?'top center':'center'};`;};const hStyle=`width:${d.hero.size}%;filter:${d.hero.gP>0?`drop-shadow(0 0 ${d.hero.gP}px ${d.hero.gC})`:''};${getAnimRule(d.hero)}`;const bStyle=`width:${d.boss.size}%;filter:${d.boss.gP>0?`drop-shadow(0 0 ${d.boss.gP}px ${d.boss.gC})`:''};${getAnimRule(d.boss)}`;
        const script=`<script>
let timerVal=${d.timer*60},timerOn=${d.timerOn},hMax=${d.hero.hp},hCur=${d.hero.hp},bMax=${d.boss.hp},bCur=${d.boss.hp},audioCtx=null,currentQIndex=-1,locIndex=0;
const quests=${JSON.stringify(this.quests)},locations=${JSON.stringify(this.locations.map(l=>l.data))};
function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();}
function beep(type){if(!audioCtx)return;const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);if(type==='win'){o.frequency.value=600;o.type='sine';g.gain.setValueAtTime(0.1,audioCtx.currentTime);o.start();o.frequency.exponentialRampToValueAtTime(1200,audioCtx.currentTime+0.1);g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.3);o.stop(audioCtx.currentTime+0.3);}else if(type==='fail'){o.frequency.value=150;o.type='sawtooth';g.gain.setValueAtTime(0.1,audioCtx.currentTime);o.start();g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.4);o.stop(audioCtx.currentTime+0.4);}else{o.frequency.value=440;o.type='square';g.gain.setValueAtTime(0.1,audioCtx.currentTime);o.start();o.stop(audioCtx.currentTime+0.1);}}
function startGame(){initAudio();beep('start');document.getElementById('start-overlay').style.display='none';document.getElementById('game-root').style.opacity='1';if(${this.musicFile!=null}){const music=document.getElementById('bg-music');music.volume=0.3;music.play();}if(timerOn)startTimer();loadNextQuestion();}
function startTimer(){const e=document.getElementById('timer-disp');const i=setInterval(()=>{timerVal--;let m=Math.floor(timerVal/60);let s=timerVal%60;e.innerText=m+':'+(s<10?'0'+s:s);if(timerVal<=0){clearInterval(i);endGame(false);}},1000);}
function updateBars(){document.getElementById('bar-h').style.width=(hCur/hMax*100)+'%';document.getElementById('bar-b').style.width=(bCur/bMax*100)+'%';}
function loadNextQuestion(){currentQIndex++;if(currentQIndex>=quests.length||hCur<=0||bCur<=0){checkWinState();return;}if(locations.length>0){locIndex=(locIndex+1)%locations.length;document.body.style.backgroundImage=\`url(\${locations[locIndex]})\`;}const q=quests[currentQIndex];document.getElementById('q-text').innerText=q.text;const p=document.getElementById('q-inputs');let html='';if(q.type==='choice'){const ans=[{t:q.correct,c:true}];q.wrongs.forEach(w=>{if(w)ans.push({t:w,c:false});});ans.sort(()=>Math.random()-0.5);html=\`<div class="btns">\${ans.map(a=>\`<button class="game-btn" onclick="checkChoice(this,\${a.c})">\${a.t}</button>\`).join('')}</div>\`;}else{html=\`<div class="inp-area"><input type="text" id="inp-ans" placeholder="..."><button class="game-btn" onclick="checkInput()">OK</button></div>\`;}p.innerHTML=html;}
function checkChoice(b,isCor){if(isCor){handleCorrect(b);}else{handleWrong(b);}}
function checkInput(){const i=document.getElementById('inp-ans');if(i.value.trim().toLowerCase()===quests[currentQIndex].correctInp.trim().toLowerCase()){handleCorrect(i);}else{handleWrong(i);}}
function handleCorrect(el){beep('win');bCur--;updateBars();document.body.style.pointerEvents='none';if(el.tagName==='BUTTON'){el.style.background='#00ff88';el.style.color='#000';}else{el.style.borderColor='#00ff88';}document.getElementById('boss-img').style.animation='fx-shake 0.5s linear';setTimeout(()=>{document.body.style.pointerEvents='';loadNextQuestion();},1000);}
function handleWrong(el){beep('fail');hCur--;updateBars();if(el.tagName==='BUTTON'){el.style.background='#ff0055';}else{el.style.borderColor='#ff0055';}document.getElementById('hero-img').style.animation='fx-shake 0.5s linear';setTimeout(()=>{const hAnim='${getAnimRule(d.hero)}';document.getElementById('hero-img').style.animation=hAnim;checkWinState();},500);}
function checkWinState(){if(bCur<=0){endGame(true);}else if(hCur<=0){endGame(false);}}
function endGame(win){document.body.style.pointerEvents='none';document.getElementById('timer-disp').style.display='none';const p=document.getElementById('q-panel');p.innerHTML="";if(win){document.getElementById('boss-img').style.opacity='0';document.getElementById('hero-img').style.animation='fx-bounce 0.5s ease infinite';p.innerHTML="<h2 style='color:#00ff88;font-size:40px;text-shadow:0 0 20px #00ff88'>${qData.win}</h2>";}else{document.getElementById('hero-img').style.opacity='0';p.innerHTML="<h2 style='color:#ff0055;font-size:40px;text-shadow:0 0 20px #ff0055'>${qData.lose}</h2>";}}
<\/script>`;
        const html=`<!DOCTYPE html><html><head><style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@700&family=Montserrat:wght@900&display=swap');
body{margin:0;overflow:hidden;font-family:'Rajdhani',sans-serif;user-select:none;width:100vw;height:100vh;background-color:#0A0912;background-size:cover;background-position:center;transition:background-image 0.5s ease-in-out;}
@keyframes fx-idle{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}@keyframes fx-float{0%,100%{transform:translateY(0) rotate(0deg)}50%{transform:translateY(-15px) rotate(2deg)}}@keyframes fx-pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}@keyframes fx-shake{0%{transform:translate(1px, 1px)}20%{transform:translate(-3px, 0px)}40%{transform:translate(1px, -1px)}60%{transform:translate(-3px, 1px)}80%{transform:translate(-1px, -1px)}100%{transform:translate(1px, -2px)}}@keyframes fx-glitch{0%{transform:translate(0)}20%{transform:translate(-2px, 2px)}40%{transform:translate(-2px, -2px)}60%{transform:translate(2px, 2px)}80%{transform:translate(2px, -2px)}100%{transform:translate(0)}}@keyframes fx-spin{0%{transform:rotateY(0deg)}100%{transform:rotateY(360deg)}}@keyframes fx-neon{0%,100%{opacity:1;filter:brightness(1)}50%{opacity:0.8;filter:brightness(1.5)}}@keyframes fx-wobble{0%,100%{transform:rotate(0deg)}25%{transform:rotate(-5deg)}75%{transform:rotate(5deg)}}@keyframes fx-swing{0%{transform:rotate(0deg)}20%{transform:rotate(15deg)}40%{transform:rotate(-10deg)}60%{transform:rotate(5deg)}80%{transform:rotate(-5deg)}100%{transform:rotate(0deg)}}@keyframes fx-bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-30px)}60%{transform:translateY(-15px)}}@keyframes fx-flip{0%{transform:rotateY(0deg)}100%{transform:rotateY(360deg)}}@keyframes fx-ghost{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(1.05)}}
.scene{display:flex;flex-direction:column;height:100%;justify-content:space-between;position:relative;opacity:0;transition:opacity 0.5s;background-image:linear-gradient(rgba(0,0,0,0.3),rgba(0,0,0,0.3));}
.overlay{position:fixed;inset:0;background:#0A0912;z-index:99;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.big-title{font-family:'Press Start 2P',cursive;font-size:clamp(24px,5vw,40px);color:#00e5ff;text-align:center;margin-bottom:40px;text-shadow:4px 4px 0 #8A2BE2;line-height:1.5;}
.play-btn{background:transparent;color:#fff;padding:15px 50px;border:2px solid #fff;border-radius:50px;font-size:24px;font-weight:900;cursor:pointer;transition:0.3s;animation:fx-pulse 2s infinite;}
.play-btn:hover{background:#00e5ff;color:#000;border-color:#00e5ff;box-shadow:0 0 30px #00e5ff;}
.hud{padding:20px;display:flex;justify-content:space-between;align-items:center;width:100%;z-index:10;}
.hud-player{display:flex;align-items:center;gap:10px;}.hud-player.right{flex-direction:row-reverse;}
.hp-bar{width: clamp(100px, 20vw, 250px);height:10px;background:rgba(0,0,0,0.7);border-radius:5px;border:1px solid #555;overflow:hidden;box-shadow:inset 0 0 5px #000;}
.hp-fill{height:100%;transition:width 0.5s ease-out;}
.char-name{color:#fff;font-weight:900;font-size:18px;text-shadow:2px 2px 0 #000;}
.timer{font-family:'Rajdhani',sans-serif;font-weight:700;font-size:36px;background:rgba(0,0,0,0.5);color:#ffd700;padding:2px 15px;border-radius:8px;letter-spacing:2px;border:1px solid rgba(255,255,255,0.2);}
.stage-area{flex:1;display:flex;justify-content:space-between;align-items:center;padding:0 10%;position:absolute;inset:0;padding-bottom:180px;}
.char-wrap{width:40%;height:85%;display:flex;align-items:flex-end;justify-content:center;}
.char{max-width:100%;max-height:100%;object-fit:contain;transition:0.5s;}
.ui-panel{position:absolute;bottom:0;left:0;right:0;background:rgba(18,16,30,0.95);padding:20px;border-top:4px solid #00e5ff;display:flex;flex-direction:column;align-items:center;gap:15px;min-height:180px;box-shadow:0 -10px 50px rgba(0,0,0,0.5);z-index:20;}
.q-text{color:#fff;font-size:24px;font-weight:700;text-align:center;font-family:'Montserrat',sans-serif;}
.btns{display:flex;gap:15px;flex-wrap:wrap;justify-content:center;width:100%;}
.game-btn{background:#333;border:2px solid #555;color:#fff;padding:15px 30px;font-family:inherit;font-weight:700;font-size:18px;cursor:pointer;text-transform:uppercase;border-radius:8px;transition:0.1s;min-width:150px;}
.game-btn:hover{background:#555;border-color:#fff;transform:translateY(-2px);}.inp-area{display:flex;gap:10px;}
input[type=text]{padding:15px;border-radius:6px;border:2px solid #fff;font-family:inherit;font-weight:700;background:#000;color:#fff;font-size:18px;outline:none;}
</style></head><body>
${this.musicFile?`<audio id="bg-music" src="${this.musicFile.data}" loop></audio>`:''}
<div class="overlay" id="start-overlay"><div class="big-title">–ë–ò–¢–í–ê<br>–° –ë–û–°–°–û–ú</div><button class="play-btn" onclick="startGame()">${qData.play}</button></div>
<div class="scene" id="game-root">
<div class="hud"><div class="hud-player"><span class="char-name">${qData.hName}</span><div class="hp-bar"><div id="bar-h" class="hp-fill" style="background:#00ff88;width:100%;"></div></div></div><div class="timer" id="timer-disp">${d.timerOn?(d.timer<10?'0'+d.timer:d.timer)+':00':''}</div><div class="hud-player right"><span class="char-name">${qData.bName}</span><div class="hp-bar"><div id="bar-b" class="hp-fill" style="background:#8A2BE2;width:100%;"></div></div></div></div>
<div class="stage-area"><div class="char-wrap"><img src="${d.hero.src}" class="char" id="hero-img" style="${hStyle}"></div><div class="char-wrap"><img src="${d.boss.src}" class="char" id="boss-img" style="${bStyle}"></div></div>
<div class="ui-panel" id="q-panel"><div class="q-text" id="q-text"></div><div id="q-inputs"></div></div>
</div>${script}</body></html>`;
        const area=document.getElementById('hidden_code');area.value=`<iframe srcdoc="${html.replace(/"/g,'&quot;')}" width="100%" height="100%" frameborder="0" style="background:transparent;display:block"></iframe>`;area.select();document.execCommand('copy');const btn=document.getElementById('b_gen');const old=btn.innerText;btn.innerText="–ì–û–¢–û–í–û!";btn.style.background="#fff";setTimeout(()=>{btn.innerText=old;btn.style.background="";},1500);
        }
    };
    app.init();
</script>
</div>
