<div id="FX_ROOT">
    <style>
        /* --- ШРИФТЫ --- */
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Montserrat:wght@400;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        /* --- ПЕРЕМЕННЫЕ --- */
        #FX_ROOT {
            --bg-dark: #050505;
            --bg-panel: rgba(18, 18, 24, 0.98);
            --cyan: #00e5ff;
            --pink: #ff0055;
            --green: #00ff88;
            --text: #ffffff;
            --border: rgba(255, 255, 255, 0.15);
            width: 100%;
            height: 100%;
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-dark);
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--text);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #FX_ROOT * { box-sizing: border-box; user-select: none; outline: none; }
        
        /* Скроллбары */
        #FX_ROOT ::-webkit-scrollbar { width: 5px; }
        #FX_ROOT ::-webkit-scrollbar-track { background: #000; }
        #FX_ROOT ::-webkit-scrollbar-thumb { background: var(--cyan); border-radius: 3px; }

        /* --- UI ЭЛЕМЕНТЫ --- */
        .fx-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px;
            cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            transition: 0.2s;
            border-radius: 4px;
            font-size: 11px;
            text-align: center;
        }
        .fx-btn:hover { border-color: var(--cyan); color: var(--cyan); background: rgba(0, 229, 255, 0.1); }
        .fx-btn.active {
            background: var(--cyan); color: #000; border-color: var(--cyan);
            box-shadow: 0 0 10px rgba(0,229,255,0.4);
        }

        .fx-input, .fx-textarea {
            background: #000;
            border: 1px solid var(--border);
            color: #fff;
            padding: 8px;
            width: 100%;
            font-size: 11px;
            border-radius: 4px;
            font-family: monospace;
            transition: 0.3s;
            margin-bottom: 5px;
        }
        .fx-input:focus, .fx-textarea:focus { border-color: var(--cyan); }
        .upload-success { border-color: var(--green) !important; box-shadow: 0 0 10px var(--green) !important; }

        /* --- РЕДАКТОР --- */
        .view-editor { flex: 1; display: flex; opacity: 1; pointer-events: auto; }

        /* Сайдбар */
        .sidebar {
            width: 380px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-shadow: 5px 0 20px rgba(0,0,0,0.5);
        }

        .main-tabs { display: flex; border-bottom: 2px solid var(--border); }
        .main-tab-link {
            flex: 1; padding: 15px 5px; text-align: center;
            background: rgba(0,0,0,0.2); border: none;
            color: #888; font-weight: 900; text-transform: uppercase;
            cursor: pointer; font-size: 12px; transition: 0.3s; letter-spacing: 1px;
        }
        .main-tab-link.active {
            color: #fff; background: rgba(255,255,255,0.05);
            border-bottom: 3px solid var(--cyan);
        }

        .sub-tabs { display: flex; gap: 5px; padding: 10px 10px 0 10px; }
        .sub-tab-link {
            flex: 1; padding: 8px;
            background: #222; border: 1px solid #444; color: #888;
            cursor: pointer; font-size: 10px; font-weight: 700;
            text-transform: uppercase; border-radius: 4px;
            transition: 0.2s;
        }
        .sub-tab-link.active {
            background: var(--cyan); color: #000; border-color: var(--cyan);
        }

        .section-content { padding: 15px; overflow-y: auto; display: none; flex-direction: column; gap: 15px; height: 100%; }
        .section-content.show { display: flex; }

        .control-group {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .control-label {
            font-size: 10px; text-transform: uppercase; color: var(--cyan);
            margin-bottom: 8px; font-weight: 700; display: block; letter-spacing: 1px;
        }

        /* Анимации Сетка */
        .anim-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        input[type="checkbox"] { accent-color: var(--cyan); transform: scale(1.2); cursor: pointer; }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 5px 0; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 12px; width: 12px;
            border-radius: 50%; background: var(--cyan); margin-top: -4px;
            cursor: pointer; border: 1px solid #fff;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer;
            background: rgba(255,255,255,0.1); border-radius: 2px;
        }

        /* --- СЦЕНА (PREVIEW) --- */
        .stage {
            flex: 1; position: relative; background-color: #000;
            background-size: cover; background-position: center;
            display: flex; flex-direction: column; justify-content: space-between;
            overflow: hidden;
        }
        .stage-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.2); z-index: 1; pointer-events: none; }
        
        /* HUD в редакторе */
        .preview-hud {
            padding: 20px; z-index: 5; display: flex; justify-content: space-between;
            width: 100%; align-items: flex-start;
        }
        .hp-bar-wrap { width: 150px; }
        .hp-label { font-size: 12px; font-weight: 900; color: #fff; text-shadow: 1px 1px 0 #000; margin-bottom: 3px; display: block; }
        .hp-track { width: 100%; height: 10px; background: #333; border: 1px solid #fff; border-radius: 2px; overflow: hidden; }
        .hp-fill { height: 100%; width: 100%; transition: 0.3s; }
        .timer-preview { font-size: 24px; font-weight: 900; color: #ffd700; text-shadow: 2px 2px 0 #000; }

        .battle-area {
            flex: 1; display: flex; justify-content: space-around; align-items: flex-end;
            padding-bottom: 150px; z-index: 2;
        }
        .char-box {
            width: 300px; height: 350px; display: flex; align-items: flex-end; justify-content: center;
        }
        .char-img { max-width: 100%; max-height: 100%; object-fit: contain; transition: 0.3s; }

        /* Окно вопросов в редакторе (визуализация) */
        .quest-dock {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(20, 20, 30, 0.95);
            border-top: 3px solid var(--cyan);
            padding: 15px; z-index: 10;
            min-height: 120px; display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .q-preview-text { color: #fff; font-size: 18px; font-weight: 700; }
        .q-preview-btns { display: flex; gap: 10px; }
        .q-dummy-btn {
            background: #444; color: #fff; padding: 8px 20px;
            border: 2px solid #666; border-radius: 5px; font-weight: 700; font-size: 12px;
        }

        /* КНОПКА ГЕНЕРАЦИИ */
        .gen-area {
            position: absolute; top: 20px; right: 20px; z-index: 50;
        }
        .btn-generate {
            background: rgba(0,0,0,0.6); color: var(--green); padding: 10px 25px;
            font-size: 14px; font-family: 'Rajdhani', sans-serif; font-weight: 700;
            text-transform: uppercase; border: 2px solid var(--green);
            border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 10px var(--green);
            transition: 0.3s;
        }
        .btn-generate:hover { background: var(--green); color: #000; box-shadow: 0 0 30px var(--green); }
        
        #hidden_code { opacity: 0; position: absolute; pointer-events: none; }

        /* Анимации Keyframes */
        @keyframes fx-shake { 0%{transform: translate(1px, 1px)} 20%{transform: translate(-3px, 0px)} 40%{transform: translate(1px, -1px)} 60%{transform: translate(-3px, 1px)} 80%{transform: translate(-1px, -1px)} 100%{transform: translate(1px, -2px)} }
    </style>

    <!-- РЕДАКТОР -->
    <div class="view-editor">
        
        <!-- ПАНЕЛЬ УПРАВЛЕНИЯ -->
        <div class="sidebar">
            <div class="main-tabs">
                <button class="main-tab-link active" onclick="app.setMainTab('chars')" id="tab_chars">ПЕРСОНАЖИ</button>
                <button class="main-tab-link" onclick="app.setMainTab('quests')" id="tab_quests">ЗАДАНИЯ</button>
            </div>

            <!-- РАЗДЕЛ: ПЕРСОНАЖИ -->
            <div class="section-content show" id="sec_chars">
                <div class="sub-tabs">
                    <button class="sub-tab-link active" onclick="app.setCharTab('hero')" id="st_hero">ГЕРОЙ</button>
                    <button class="sub-tab-link" onclick="app.setCharTab('boss')" id="st_boss">БОСС</button>
                </div>

                <!-- НАСТРОЙКИ ГЕРОЯ -->
                <div id="cfg_hero">
                    <div class="control-group">
                        <span class="control-label">Имя Героя</span>
                        <input type="text" class="fx-input" id="i_h_name" value="Студент">
                        <button class="fx-btn" style="width:100%" onclick="document.getElementById('f_hero').click()" id="b_h_up">ЗАГРУЗИТЬ КАРТИНКУ</button>
                        <input type="file" id="f_hero" hidden accept="image/*">
                        <input type="text" class="fx-input" id="u_hero" placeholder="Или ссылка на картинку..." style="margin-top:5px">
                    </div>
                    <div class="control-group">
                        <span class="control-label">Анимация покоя</span>
                        <div class="anim-grid" id="ag_hero"></div>
                    </div>
                    <div class="control-group">
                        <span class="control-label">Параметры</span>
                        <div class="toggle-row">
                            <label style="font-size:9px; color:#aaa;">Размер</label>
                            <input type="range" id="r_h_size" min="50" max="150" value="100" style="width:60%">
                        </div>
                        <div class="toggle-row">
                            <label style="font-size:9px; color:#aaa;">Здоровье (HP)</label>
                            <input type="number" class="fx-input" id="i_h_hp" value="3" style="width:50px; text-align:center;">
                        </div>
                        <div style="display:flex; gap:5px; margin-top:5px; align-items:center;">
                            <label style="font-size:9px; color:#aaa;">Свечение:</label>
                            <input type="color" id="c_h_glow" value="#00e5ff" style="border:none; width:20px; height:20px; background:none; padding:0;">
                            <input type="range" id="r_h_glow" min="0" max="50" value="0">
                        </div>
                    </div>
                </div>

                <!-- НАСТРОЙКИ БОССА (Скрыты по умолчанию) -->
                <div id="cfg_boss" style="display:none;">
                    <div class="control-group">
                        <span class="control-label">Имя Босса</span>
                        <input type="text" class="fx-input" id="i_b_name" value="ПРОФЕССОР">
                        <button class="fx-btn" style="width:100%" onclick="document.getElementById('f_boss').click()" id="b_b_up">ЗАГРУЗИТЬ КАРТИНКУ</button>
                        <input type="file" id="f_boss" hidden accept="image/*">
                        <input type="text" class="fx-input" id="u_boss" placeholder="Или ссылка на картинку..." style="margin-top:5px">
                    </div>
                    <div class="control-group">
                        <span class="control-label">Анимация покоя</span>
                        <div class="anim-grid" id="ag_boss"></div>
                    </div>
                    <div class="control-group">
                        <span class="control-label">Параметры</span>
                        <div class="toggle-row">
                            <label style="font-size:9px; color:#aaa;">Размер</label>
                            <input type="range" id="r_b_size" min="50" max="150" value="100" style="width:60%">
                        </div>
                        <div class="toggle-row">
                            <label style="font-size:9px; color:#aaa;">Здоровье (HP)</label>
                            <input type="number" class="fx-input" id="i_b_hp" value="5" style="width:50px; text-align:center;">
                        </div>
                        <div style="display:flex; gap:5px; margin-top:5px; align-items:center;">
                            <label style="font-size:9px; color:#aaa;">Свечение:</label>
                            <input type="color" id="c_b_glow" value="#ff0055" style="border:none; width:20px; height:20px; background:none; padding:0;">
                            <input type="range" id="r_b_glow" min="0" max="50" value="0">
                        </div>
                    </div>
                </div>
            </div>

            <!-- РАЗДЕЛ: ЗАДАНИЯ -->
            <div class="section-content" id="sec_quests">
                <!-- Фон -->
                <div class="control-group">
                    <span class="control-label">Фон игры</span>
                    <button class="fx-btn" style="width:100%" onclick="document.getElementById('f_bg').click()" id="b_bg_up">ЗАГРУЗИТЬ ФОН</button>
                    <input type="file" id="f_bg" hidden accept="image/*">
                </div>
                
                <!-- Таймер -->
                <div class="control-group">
                    <div class="toggle-row">
                        <span class="control-label" style="margin:0">Таймер (мин)</span>
                        <input type="checkbox" id="chk_timer" checked>
                    </div>
                    <input type="range" id="r_timer" min="1" max="30" value="5">
                    <div style="text-align:right; font-size:10px; color:var(--cyan);"><span id="val_timer">5</span> мин</div>
                </div>

                <!-- Сообщения игры (Язык) -->
                <div class="control-group">
                    <span class="control-label">Тексты / Язык заданий</span>
                    <label style="font-size:9px; color:#888;">Победа:</label>
                    <input type="text" class="fx-input" id="i_win_msg" value="ПОБЕДА!">
                    <label style="font-size:9px; color:#888;">Поражение (время/жизни):</label>
                    <input type="text" class="fx-input" id="i_lose_msg" value="ИГРА ОКОНЧЕНА">
                </div>

                <!-- Вопрос -->
                <div class="control-group">
                    <span class="control-label">Тип задания</span>
                    <div class="sub-tabs" style="padding:0; margin-bottom:10px;">
                        <button class="sub-tab-link active" onclick="app.setQType('choice')" id="b_choice">ВЫБОР</button>
                        <button class="sub-tab-link" onclick="app.setQType('input')" id="b_input">ВВОД</button>
                    </div>
                    
                    <span class="control-label">Текст вопроса</span>
                    <textarea class="fx-textarea" id="i_q_text" rows="2" oninput="app.updatePreview()">Сколько будет 2 + 2?</textarea>
                    
                    <!-- Поля для ВЫБОРА -->
                    <div id="area_choice">
                        <span class="control-label" style="color:var(--green)">Верный ответ</span>
                        <input type="text" class="fx-input" id="i_c_ans" value="4" oninput="app.updatePreview()">
                        <span class="control-label" style="color:var(--pink)">Неверные ответы</span>
                        <input type="text" class="fx-input" id="i_w1" value="5" oninput="app.updatePreview()">
                        <input type="text" class="fx-input" id="i_w2" value="22" oninput="app.updatePreview()">
                    </div>
                    
                    <!-- Поля для ВВОДА -->
                    <div id="area_input" style="display:none">
                        <span class="control-label" style="color:var(--green)">Правильный текст</span>
                        <input type="text" class="fx-input" id="i_in_ans" value="4">
                        <div style="font-size:9px; color:#666; margin-top:2px;">* Регистр не важен</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- СЦЕНА (ПРЕВЬЮ) -->
        <div class="stage" id="stage_bg">
            <div class="stage-overlay"></div>
            
            <div class="gen-area">
                <button class="btn-generate" onclick="app.generate()" id="b_gen">СКОПИРОВАТЬ КОД</button>
            </div>

            <!-- HUD Превью -->
            <div class="preview-hud">
                <div class="hp-bar-wrap">
                    <span class="hp-label" id="p_h_name">Студент</span>
                    <div class="hp-track"><div class="hp-fill" style="background:#00ff88; width:100%"></div></div>
                </div>
                <div class="timer-preview" id="p_timer">05:00</div>
                <div class="hp-bar-wrap" style="text-align:right">
                    <span class="hp-label" id="p_b_name">БОСС</span>
                    <div class="hp-track"><div class="hp-fill" style="background:#ff0055; width:100%"></div></div>
                </div>
            </div>

            <!-- Персонажи -->
            <div class="battle-area">
                <div class="char-box" id="box_hero">
                    <img src="https://cdn-icons-png.flaticon.com/512/3408/3408506.png" class="char-img" id="img_hero">
                </div>
                <div class="char-box" id="box_boss">
                    <img src="https://cdn-icons-png.flaticon.com/512/2312/2312264.png" class="char-img" id="img_boss" style="filter: hue-rotate(-20deg);">
                </div>
            </div>

            <!-- Окно вопроса (визуализация) -->
            <div class="quest-dock">
                <div class="q-preview-text" id="prev_q_text">Текст вопроса...</div>
                <div class="q-preview-btns" id="prev_q_btns">
                    <div class="q-dummy-btn">ОТВЕТ 1</div>
                    <div class="q-dummy-btn">ОТВЕТ 2</div>
                </div>
            </div>
        </div>
        
        <textarea id="hidden_code"></textarea>
    </div>

    <script>
        const app = {
            qType: 'choice',
            data: {
                hero: { src: 'https://cdn-icons-png.flaticon.com/512/3408/3408506.png', anim: 'idle', size: 100, hp: 3, gC: '#00e5ff', gP: 0 },
                boss: { src: 'https://cdn-icons-png.flaticon.com/512/2312/2312264.png', anim: 'idle', size: 100, hp: 5, gC: '#ff0055', gP: 0 },
                bg: '',
                timer: 5,
                timerOn: true
            },
            anims: [
                { id: 'idle', name: 'Покой' },
                { id: 'float', name: 'Парение' },
                { id: 'pulse', name: 'Пульс' },
                { id: 'shake', name: 'Тряска' },
                { id: 'glitch', name: 'Глюк' },
                { id: 'spin', name: 'Вращение' },
                { id: 'neon', name: 'Неон' },
                { id: 'wobble', name: 'Шатание' },
                { id: 'swing', name: 'Качание' },
                { id: 'bounce', name: 'Прыжок' },
                { id: 'flip', name: 'Переворот' },
                { id: 'ghost', name: 'Призрак' }
            ],

            init() {
                this.renderAnims('hero');
                this.renderAnims('boss');
                this.bindEvents();
                this.updatePreview();
            },

            setMainTab(t) {
                document.getElementById('tab_chars').classList.remove('active');
                document.getElementById('tab_quests').classList.remove('active');
                document.getElementById('sec_chars').classList.remove('show');
                document.getElementById('sec_quests').classList.remove('show');
                
                document.getElementById('tab_' + t).classList.add('active');
                document.getElementById('sec_' + t).classList.add('show');
            },

            setCharTab(t) {
                document.getElementById('st_hero').classList.remove('active');
                document.getElementById('st_boss').classList.remove('active');
                document.getElementById('cfg_hero').style.display = 'none';
                document.getElementById('cfg_boss').style.display = 'none';

                document.getElementById('st_' + t).classList.add('active');
                document.getElementById('cfg_' + t).style.display = 'block';
            },

            setQType(t) {
                this.qType = t;
                document.getElementById('b_choice').className = t==='choice'?'sub-tab-link active':'sub-tab-link';
                document.getElementById('b_input').className = t==='input'?'sub-tab-link active':'sub-tab-link';
                document.getElementById('area_choice').style.display = t==='choice'?'block':'none';
                document.getElementById('area_input').style.display = t==='input'?'block':'none';
                this.updatePreview();
            },

            renderAnims(target) {
                const grid = document.getElementById('ag_'+target);
                grid.innerHTML = '';
                this.anims.forEach(a => {
                    const b = document.createElement('div');
                    b.className = 'fx-btn' + (this.data[target].anim === a.id ? ' active' : '');
                    b.innerText = a.name;
                    b.onclick = () => {
                        this.data[target].anim = a.id;
                        this.renderAnims(target);
                        this.updatePreview();
                    };
                    grid.appendChild(b);
                });
            },

            handleImage(file, target, isBg = false) {
                if(file) {
                    const r = new FileReader();
                    r.onload = (e) => {
                        if(isBg) {
                            this.data.bg = e.target.result;
                            document.getElementById('b_bg_up').classList.add('upload-success');
                        } else {
                            this.data[target].src = e.target.result;
                            const btnId = target==='hero'?'b_h_up':'b_b_up';
                            document.getElementById(btnId).classList.add('upload-success');
                        }
                        this.updatePreview();
                    };
                    r.readAsDataURL(file);
                }
            },

            bindEvents() {
                // Картинки
                document.getElementById('f_hero').onchange = (e) => this.handleImage(e.target.files[0], 'hero');
                document.getElementById('f_boss').onchange = (e) => this.handleImage(e.target.files[0], 'boss');
                document.getElementById('f_bg').onchange = (e) => this.handleImage(e.target.files[0], null, true);

                // URL
                ['hero','boss'].forEach(t => {
                    document.getElementById('u_'+t).oninput = (e) => {
                        if(e.target.value) { this.data[t].src = e.target.value; this.updatePreview(); }
                    };
                    document.getElementById('i_'+t.charAt(0)+'_name').oninput = () => this.updatePreview();
                });

                // Слайдеры
                const bindS = (id, target, key) => document.getElementById(id).oninput = (e) => {
                    this.data[target][key] = e.target.value;
                    this.updatePreview();
                };
                bindS('r_h_size','hero','size');
                bindS('r_b_size','boss','size');
                bindS('r_h_glow','hero','gP');
                bindS('r_b_glow','boss','gP');
                bindS('i_h_hp','hero','hp');
                bindS('i_b_hp','boss','hp');

                // Цвета
                document.getElementById('c_h_glow').oninput = (e) => { this.data.hero.gC = e.target.value; this.updatePreview(); };
                document.getElementById('c_b_glow').oninput = (e) => { this.data.boss.gC = e.target.value; this.updatePreview(); };

                // Таймер
                document.getElementById('chk_timer').onchange = (e) => {
                    this.data.timerOn = e.target.checked;
                    this.updatePreview();
                };
                document.getElementById('r_timer').oninput = (e) => {
                    this.data.timer = e.target.value;
                    document.getElementById('val_timer').innerText = e.target.value;
                    this.updatePreview();
                }
            },

            updatePreview() {
                const h = this.data.hero;
                const b = this.data.boss;

                // Фон
                document.getElementById('stage_bg').style.backgroundImage = this.data.bg ? `url(${this.data.bg})` : 'none';

                // Имена
                document.getElementById('p_h_name').innerText = document.getElementById('i_h_name').value;
                document.getElementById('p_b_name').innerText = document.getElementById('i_b_name').value;

                // Таймер
                document.getElementById('p_timer').innerText = this.data.timerOn ? (this.data.timer < 10 ? '0'+this.data.timer : this.data.timer) + ':00' : '';

                // Вопрос превью
                document.getElementById('prev_q_text').innerText = document.getElementById('i_q_text').value;
                const btnsDiv = document.getElementById('prev_q_btns');
                if(this.qType === 'choice') {
                    const ans1 = document.getElementById('i_c_ans').value;
                    const ans2 = document.getElementById('i_w1').value;
                    btnsDiv.innerHTML = `<div class="q-dummy-btn">${ans1}</div><div class="q-dummy-btn">${ans2}</div>`;
                } else {
                    btnsDiv.innerHTML = `<input type="text" class="fx-input" style="width:100px" disabled placeholder="Ответ..."><div class="q-dummy-btn">OK</div>`;
                }

                // Персонажи
                const apply = (elId, d) => {
                    const img = document.getElementById(elId);
                    img.src = d.src;
                    img.parentNode.style.width = (d.size * 0.4) + '%';
                    
                    const filter = d.gP > 0 ? `drop-shadow(0 0 ${d.gP}px ${d.gC})` : 'none';
                    img.style.filter = filter;

                    // Логика анимации
                    let dur = 2;
                    if(['shake','wobble'].includes(d.anim)) dur = 0.8;
                    if(['flip','ghost'].includes(d.anim)) dur = 3;
                    let timing = d.anim === 'glitch' ? 'steps(2)' : 'ease-in-out';
                    if(['shake','spin','flip'].includes(d.anim)) timing = 'linear';
                    if(['bounce'].includes(d.anim)) timing = 'ease';

                    if(d.anim !== 'none') {
                        img.style.animation = `fx-${d.anim} ${dur}s infinite ${timing}`;
                        if(d.anim === 'swing') img.style.transformOrigin = 'top center';
                        else img.style.transformOrigin = 'center';
                    } else {
                        img.style.animation = 'none';
                    }
                };
                apply('img_hero', h);
                apply('img_boss', b);
            },

            generate() {
                const d = this.data;
                const qData = {
                    hName: document.getElementById('i_h_name').value,
                    bName: document.getElementById('i_b_name').value,
                    qText: document.getElementById('i_q_text').value,
                    win: document.getElementById('i_win_msg').value,
                    lose: document.getElementById('i_lose_msg').value,
                    correct: this.qType === 'choice' ? document.getElementById('i_c_ans').value : document.getElementById('i_in_ans').value,
                    wrongs: [document.getElementById('i_w1').value, document.getElementById('i_w2').value]
                };

                // CSS анимации
                const getAnimRule = (o) => {
                    if(o.anim === 'none') return '';
                    let dur = 2;
                    if(['shake','wobble'].includes(o.anim)) dur = 0.8;
                    if(['flip','ghost'].includes(o.anim)) dur = 3;
                    let timing = o.anim === 'glitch' ? 'steps(2)' : 'ease-in-out';
                    if(['shake','spin','flip'].includes(o.anim)) timing = 'linear';
                    if(['bounce'].includes(o.anim)) timing = 'ease';
                    let origin = o.anim==='swing' ? 'transform-origin:top center;' : '';
                    return `animation: fx-${o.anim} ${dur}s infinite ${timing}; ${origin}`;
                };

                const hStyle = `width:${d.hero.size}%; filter:${d.hero.gP>0?`drop-shadow(0 0 ${d.hero.gP}px ${d.hero.gC})`:''}; ${getAnimRule(d.hero)}`;
                const bStyle = `width:${d.boss.size}%; filter:${d.boss.gP>0?`drop-shadow(0 0 ${d.boss.gP}px ${d.boss.gC})`:''}; ${getAnimRule(d.boss)}`;

                // Логика игры
                let inputHtml = '';
                if(this.qType === 'choice') {
                    const ans = [{t:qData.correct, c:true}, {t:qData.wrongs[0], c:false}];
                    if(qData.wrongs[1]) ans.push({t:qData.wrongs[1], c:false});
                    ans.sort(()=>Math.random()-0.5);
                    inputHtml = `<div class="btns">${ans.map(a => `<button class="game-btn" onclick="checkChoice(this, ${a.c})">${a.t}</button>`).join('')}</div>`;
                } else {
                    inputHtml = `<div class="inp-area"><input type="text" id="inp-ans" placeholder="Ваш ответ..."><button class="game-btn" onclick="checkInput()">ОК</button></div>`;
                }

                const script = `
<script>
let timerVal = ${d.timer * 60};
let timerOn = ${d.timerOn};
let hMax = ${d.hero.hp}, hCur = ${d.hero.hp};
let bMax = ${d.boss.hp}, bCur = ${d.boss.hp};
let audioCtx = null;

function initAudio() {
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function beep(type) {
    if(!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    if(type === 'win') {
        osc.frequency.value = 600;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.start();
        osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        osc.stop(audioCtx.currentTime + 0.3);
    } else {
        osc.frequency.value = 150;
        osc.type = 'sawtooth';
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
        osc.stop(audioCtx.currentTime + 0.4);
    }
}

function startGame() {
    initAudio();
    document.getElementById('start-overlay').style.display = 'none';
    const cd = document.getElementById('cnt-overlay');
    cd.style.display = 'flex';
    let count = 3;
    const interval = setInterval(() => {
        if(count > 0) {
             cd.innerText = count;
             count--;
        } else {
            clearInterval(interval);
            cd.style.display = 'none';
            document.getElementById('game-root').style.opacity = '1';
            if(timerOn) startTimer();
        }
    }, 1000);
}

function startTimer() {
    const el = document.getElementById('timer-disp');
    const interval = setInterval(() => {
        timerVal--;
        let m = Math.floor(timerVal / 60);
        let s = timerVal % 60;
        el.innerText = m + ':' + (s < 10 ? '0'+s : s);
        if(timerVal <= 0) {
            clearInterval(interval);
            endGame(false);
        }
    }, 1000);
}

function updateBars() {
    const hPct = (hCur / hMax) * 100;
    const bPct = (bCur / bMax) * 100;
    document.getElementById('bar-h').style.width = hPct + '%';
    document.getElementById('bar-b').style.width = bPct + '%';
}

function checkChoice(btn, isCor) {
    if(isCor) {
        beep('win');
        bCur--;
        btn.style.background = '#00ff88';
        btn.style.color = '#000';
        document.getElementById('boss-img').style.animation = 'fx-shake 0.5s linear';
    } else {
        beep('fail');
        hCur--;
        btn.style.background = '#ff0055';
        document.getElementById('hero-img').style.animation = 'fx-shake 0.5s linear';
    }
    updateBars();
    setTimeout(() => {
        btn.style.background = ''; 
        btn.style.color = '';
        document.getElementById('boss-img').style.animation = '${d.boss.anim !== "none" ? "fx-" + d.boss.anim : "none"} 2s infinite ease-in-out';
        document.getElementById('hero-img').style.animation = '${d.hero.anim !== "none" ? "fx-" + d.hero.anim : "none"} 2s infinite ease-in-out';
        checkWin();
    }, 800);
}

function checkInput() {
    const val = document.getElementById('inp-ans').value.trim().toLowerCase();
    const cor = "${qData.correct}".trim().toLowerCase();
    const i = document.getElementById('inp-ans');
    if(val === cor) {
        beep('win');
        bCur--;
        i.style.borderColor = '#00ff88';
        document.getElementById('boss-img').style.animation = 'fx-shake 0.5s linear';
    } else {
        beep('fail');
        hCur--;
        i.style.borderColor = '#ff0055';
        document.getElementById('hero-img').style.animation = 'fx-shake 0.5s linear';
    }
    updateBars();
    setTimeout(() => {
        i.style.borderColor = '#fff';
        document.getElementById('boss-img').style.animation = '${d.boss.anim !== "none" ? "fx-" + d.boss.anim : "none"} 2s infinite ease-in-out';
        document.getElementById('hero-img').style.animation = '${d.hero.anim !== "none" ? "fx-" + d.hero.anim : "none"} 2s infinite ease-in-out';
        checkWin();
    }, 800);
}

function checkWin() {
    if(bCur <= 0) endGame(true);
    else if(hCur <= 0) endGame(false);
}

function endGame(win) {
    const p = document.getElementById('q-panel');
    p.innerHTML = "";
    if(win) {
         document.getElementById('boss-img').style.opacity = '0';
         document.getElementById('hero-img').style.animation = 'fx-bounce 0.5s ease infinite';
         p.innerHTML = "<h2 style='color:#00ff88; font-size:40px; text-shadow:0 0 20px #00ff88'>${qData.win}</h2>";
    } else {
         document.getElementById('hero-img').style.opacity = '0';
         p.innerHTML = "<h2 style='color:#ff0055; font-size:40px; text-shadow:0 0 20px #ff0055'>${qData.lose}</h2>";
    }
}
<\/script>`;

                const html = `
<!DOCTYPE html>
<html>
<head>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@700&family=Montserrat:wght@900&display=swap');
body { margin:0; overflow:hidden; font-family:'Rajdhani',sans-serif; user-select:none; width:100vw; height:100vh; background: #000; }

/* Анимации */
@keyframes fx-idle { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
@keyframes fx-float { 0%,100%{transform:translateY(0) rotate(0deg)} 50%{transform:translateY(-15px) rotate(2deg)} }
@keyframes fx-pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
@keyframes fx-shake { 0%{transform: translate(1px, 1px)} 20%{transform: translate(-3px, 0px)} 40%{transform: translate(1px, -1px)} 60%{transform: translate(-3px, 1px)} 80%{transform: translate(-1px, -1px)} 100%{transform: translate(1px, -2px)} }
@keyframes fx-glitch { 0%{transform: translate(0)} 20%{transform: translate(-2px, 2px)} 40%{transform: translate(-2px, -2px)} 60%{transform: translate(2px, 2px)} 80%{transform: translate(2px, -2px)} 100%{transform: translate(0)} }
@keyframes fx-spin { 0%{transform: rotateY(0deg)} 100%{transform: rotateY(360deg)} }
@keyframes fx-neon { 0%,100%{opacity: 1; filter: brightness(1)} 50%{opacity: 0.8; filter: brightness(1.5)} }
@keyframes fx-wobble { 0%,100%{transform:rotate(0deg)} 25%{transform:rotate(-5deg)} 75%{transform:rotate(5deg)} }
@keyframes fx-swing { 0%{transform:rotate(0deg)} 20%{transform:rotate(15deg)} 40%{transform:rotate(-10deg)} 60%{transform:rotate(5deg)} 80%{transform:rotate(-5deg)} 100%{transform:rotate(0deg)} }
@keyframes fx-bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-30px);} 60% {transform: translateY(-15px);} }
@keyframes fx-flip { 0% {transform: rotateY(0);} 100% {transform: rotateY(360deg);} }
@keyframes fx-ghost { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(1.05); } }

.scene { display:flex; flex-direction:column; height:100%; justify-content:space-between; position:relative; opacity:0; transition:1s; 
background: ${d.bg ? `url(${d.bg}) center/cover` : 'transparent'}; }

/* Overlays */
.overlay { position:fixed; inset:0; background:#050505; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; }
.big-title { font-family: 'Press Start 2P', cursive; font-size:40px; color:#00e5ff; text-align:center; margin-bottom:40px; text-shadow: 4px 4px 0 #ff0055; line-height:1.5; }
.play-btn { background:transparent; color:#fff; padding:15px 50px; border:2px solid #fff; border-radius:50px; font-size:24px; font-weight:900; cursor:pointer; transition:0.3s; animation: fx-pulse 2s infinite; }
.play-btn:hover { background:#00e5ff; color:#000; border-color:#00e5ff; box-shadow:0 0 30px #00e5ff; }
.count-num { font-size:150px; font-weight:900; color:#fff; animation: fx-pulse 0.5s infinite; }

/* HUD */
.hud { padding:20px; display:flex; justify-content:space-between; z-index:10; width:100%; align-items:flex-start; }
.hp-wrap { width:200px; }
.hp-name { color:#fff; font-weight:900; font-size:14px; margin-bottom:5px; display:block; text-shadow:2px 2px 0 #000; }
.hp-track { width:100%; height:12px; background:rgba(0,0,0,0.8); border:2px solid #fff; border-radius:4px; overflow:hidden; }
.hp-fill { height:100%; transition:0.5s cubic-bezier(0.4, 0.0, 0.2, 1); }
.timer { color:#ffd700; font-size:30px; font-weight:900; text-shadow:3px 3px 0 #000; }

.stage { flex:1; display:flex; justify-content:space-between; align-items:flex-end; padding:0 10%; perspective:1000px; }
.char-wrap { width:40%; height:85%; display:flex; align-items:flex-end; justify-content:center; }
.char { max-width:100%; max-height:100%; object-fit:contain; transition:0.5s; }

.ui-panel { background:rgba(20,20,30,0.95); padding:20px; border-top:4px solid #00e5ff; display:flex; flex-direction:column; align-items:center; gap:20px; min-height:180px; box-shadow:0 -10px 50px rgba(0,0,0,0.5); }
.q-text { color:#fff; font-size:24px; font-weight:700; text-align:center; font-family: 'Montserrat', sans-serif; }
.btns { display:flex; gap:15px; flex-wrap:wrap; justify-content:center; width:100%; }
.game-btn { background:#444; border:2px solid #666; color:#fff; padding:15px 30px; font-family:inherit; font-weight:700; font-size:18px; cursor:pointer; text-transform:uppercase; border-radius:8px; transition:0.1s; min-width:150px; }
.game-btn:hover { background:#666; border-color:#fff; transform:translateY(-2px); }
.inp-area { display:flex; gap:10px; }
input[type=text] { padding:15px; border-radius:6px; border:2px solid #fff; font-family:inherit; font-weight:700; background:#000; color:#fff; font-size:18px; outline:none; }
</style>
</head>
<body>
    <div class="overlay" id="start-overlay">
        <div class="big-title">БИТВА<br>С БОССОМ</div>
        <button class="play-btn" onclick="startGame()">ИГРАТЬ</button>
    </div>
    <div class="overlay" id="cnt-overlay" style="display:none; background:rgba(0,0,0,0.8)">
        <div class="count-num">3</div>
    </div>

    <div class="scene" id="game-root">
        <div class="hud">
            <div class="hp-wrap">
                <span class="hp-name">${qData.hName}</span>
                <div class="hp-track"><div class="hp-fill" id="bar-h" style="background:#00ff88; width:100%"></div></div>
            </div>
            <div class="timer" id="timer-disp">${d.timerOn ? (d.timer<10?'0'+d.timer:d.timer)+':00' : ''}</div>
            <div class="hp-wrap" style="text-align:right">
                <span class="hp-name">${qData.bName}</span>
                <div class="hp-track"><div class="hp-fill" id="bar-b" style="background:#ff0055; width:100%"></div></div>
            </div>
        </div>
        <div class="stage">
            <div class="char-wrap"><img src="${d.hero.src}" class="char" id="hero-img" style="${hStyle}"></div>
            <div class="char-wrap"><img src="${d.boss.src}" class="char" id="boss-img" style="${bStyle}"></div>
        </div>
        <div class="ui-panel" id="q-panel">
            <div class="q-text">${qData.qText}</div>
            ${inputHtml}
        </div>
    </div>
    ${script}
</body>
</html>`;

                const area = document.getElementById('hidden_code');
                // Escape HTML for srcdoc, but here we copy full HTML to clipboard
                area.value = `<iframe srcdoc="${html.replace(/"/g, '&quot;')}" width="100%" height="100%" frameborder="0" style="background:transparent; display:block"></iframe>`;
                area.select();
                document.execCommand('copy');

                const btn = document.getElementById('b_gen');
                const old = btn.innerText;
                btn.innerText = "ГОТОВО!";
                btn.style.borderColor = "#00ff88";
                btn.style.color = "#00ff88";
                setTimeout(() => {
                    btn.innerText = old;
                    btn.style.borderColor = "";
                    btn.style.color = "";
                }, 1500);
            }
        };

        app.init();
    </script>
</div>
