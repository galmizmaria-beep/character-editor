<div id="FX_ROOT">
  <style>
    /* --- ШРИФТЫ --- */
    @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Montserrat:wght@400;700;900&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    /* --- ПЕРЕМЕННЫЕ --- */
    #FX_ROOT {
      --bg-dark: #050505;
      --bg-panel: rgba(18, 18, 24, 0.96);
      --primary: #ffd700; /* Золотой (RPG стиль) */
      --cyan: #00e5ff;
      --pink: #ff0055;
      --green: #00ff88;
      --grey: #444;
      --text: #ffffff;
      --border: rgba(255, 255, 255, 0.15);
      
      width: 100%; height: 100%;
      font-family: 'Montserrat', sans-serif;
      background: var(--bg-dark);
      /* Фоновая сетка */
      background-image: 
        linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
      background-size: 30px 30px;
      color: var(--text);
      overflow: hidden;
      position: relative;
      display: flex; flex-direction: column;
    }
    
    #FX_ROOT * { box-sizing: border-box; user-select: none; outline: none; }
    
    /* Скроллбары */
    #FX_ROOT ::-webkit-scrollbar { width: 5px; }
    #FX_ROOT ::-webkit-scrollbar-track { background: #000; }
    #FX_ROOT ::-webkit-scrollbar-thumb { background: var(--cyan); border-radius: 3px; }

    /* --- UI ЭЛЕМЕНТЫ --- */
    .fx-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
      text-transform: uppercase;
      transition: 0.2s;
      border-radius: 4px;
      font-size: 11px;
      text-align: center;
    }
    .fx-btn:hover { border-color: var(--cyan); color: var(--cyan); background: rgba(0, 229, 255, 0.1); }
    .fx-btn.active { background: var(--cyan); color: #000; border-color: var(--cyan); box-shadow: 0 0 10px rgba(0,229,255,0.4); }
    
    .fx-input, .fx-textarea {
      background: #000; border: 1px solid var(--border); color: #fff;
      padding: 8px; width: 100%; font-size: 11px; border-radius: 4px;
      font-family: monospace; transition: 0.3s; margin-bottom: 5px;
    }
    .fx-input:focus, .fx-textarea:focus { border-color: var(--cyan); }

    /* Успешная загрузка */
    .upload-success { border-color: var(--green) !important; box-shadow: 0 0 10px var(--green) !important; }

    /* --- ЛАНДИНГ (ЯЗЫК) --- */
    .view-landing {
      position: absolute; inset: 0; z-index: 50;
      background: var(--bg-dark);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: transform 0.6s cubic-bezier(0.7,0,0.3,1);
    }
    .view-landing.hidden { transform: translateY(-100%); pointer-events: none; }
    
    .landing-title { font-family: 'Press Start 2P', cursive; font-size: 40px; line-height: 1.5; margin-bottom: 40px; text-align: center; color: var(--cyan); text-shadow: 4px 4px 0 #ff0055; }
    
    .lang-select { display: flex; gap: 20px; }
    .btn-lang {
      width: 100px; height: 100px; border-radius: 12px;
      border: 2px solid var(--border); background: rgba(255,255,255,0.05);
      font-size: 24px; font-weight: 900; color: #fff; cursor: pointer;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: 0.3s;
    }
    .btn-lang:hover { border-color: var(--cyan); background: rgba(0, 229, 255, 0.1); transform: scale(1.05); }

    /* --- РЕДАКТОР --- */
    .view-editor {
      flex: 1; display: flex; opacity: 0; transition: opacity 1s 0.5s; pointer-events: none;
    }
    .view-editor.visible { opacity: 1; pointer-events: auto; }

    /* Сайдбар */
    .sidebar {
      width: 360px; background: var(--bg-panel); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; z-index: 10;
    }
    
    .tabs-header { display: flex; border-bottom: 1px solid var(--border); }
    .tab-link {
      flex: 1; padding: 12px 5px; text-align: center; background: transparent; border: none;
      color: #888; font-weight: 800; text-transform: uppercase; cursor: pointer;
      font-size: 11px; transition: 0.3s;
    }
    .tab-link:hover { color: #fff; }
    .tab-link.active { color: var(--cyan); background: rgba(255,255,255,0.05); border-bottom: 2px solid var(--cyan); }

    .tab-content { padding: 15px; overflow-y: auto; display: none; flex-direction: column; gap: 15px; height: 100%; }
    .tab-content.show { display: flex; }

    .control-group { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; border: 1px solid var(--border); }
    .control-label { font-size: 10px; text-transform: uppercase; color: var(--cyan); margin-bottom: 8px; font-weight: 700; display: block; letter-spacing: 1px; }

    /* Сетки и контролы */
    .anim-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
    .type-switch { display: flex; gap: 5px; margin-bottom: 10px; }
    .type-btn { flex: 1; padding: 8px; background: #222; border: 1px solid #444; color: #888; cursor: pointer; font-size: 10px; text-transform: uppercase; font-weight: 700; border-radius: 4px; }
    .type-btn.active { background: var(--cyan); color: #000; border-color: var(--cyan); }

    .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    input[type="checkbox"] { accent-color: var(--cyan); transform: scale(1.2); cursor: pointer; }

    /* Input Range */
    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 5px 0; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%;
      background: var(--cyan); margin-top: -4px; cursor: pointer; border: 1px solid #fff;
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.1); border-radius: 2px;
    }

    /* --- СЦЕНА (PREVIEW) --- */
    .stage {
      flex: 1; position: relative;
      background-color: #000;
      background-size: cover; background-position: center;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
    }
    .stage-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.4); z-index: 1; pointer-events: none; }

    .battle-preview {
      width: 90%; height: 70%; display: flex; justify-content: space-between; align-items: flex-end; z-index: 2; position: relative;
    }
    .char-box { width: 40%; height: 100%; display: flex; align-items: flex-end; justify-content: center; position: relative; }
    .char-img {
      max-width: 100%; max-height: 100%; object-fit: contain; transition: 0.3s;
      /* CSS Vars for anims */
    }

    /* КНОПКА ГЕНЕРАЦИИ */
    .code-dock {
      position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 20;
    }
    .btn-generate {
      background: transparent;
      color: #fff;
      padding: 15px 40px;
      font-size: 16px;
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
      text-transform: uppercase;
      border: 2px solid #fff;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 0 10px var(--cyan), inset 0 0 10px var(--cyan);
      text-shadow: 0 0 5px var(--cyan);
      transition: 0.3s;
      animation: neonPulse 2s infinite;
    }
    @keyframes neonPulse { 0%,100%{box-shadow: 0 0 10px var(--cyan), inset 0 0 10px var(--cyan);} 50%{box-shadow: 0 0 25px var(--cyan), inset 0 0 20px var(--cyan); text-shadow:0 0 10px #fff;} }
    .btn-generate:hover { background: var(--cyan); color: #000; box-shadow: 0 0 50px var(--cyan); }
    
    #hidden_code { opacity: 0; position: absolute; pointer-events: none; }

    /* --- CSS KEYFRAMES ДЛЯ АНИМАЦИЙ --- */
    @keyframes fx-idle { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
    @keyframes fx-float { 0%,100%{transform:translateY(0) rotate(0deg)} 50%{transform:translateY(-15px) rotate(2deg)} }
    @keyframes fx-pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
    @keyframes fx-shake { 0%{transform: translate(1px, 1px)} 20%{transform: translate(-3px, 0px)} 40%{transform: translate(1px, -1px)} 60%{transform: translate(-3px, 1px)} 80%{transform: translate(-1px, -1px)} 100%{transform: translate(1px, -2px)} }
    @keyframes fx-glitch { 0%{transform: translate(0)} 20%{transform: translate(-2px, 2px)} 40%{transform: translate(-2px, -2px)} 60%{transform: translate(2px, 2px)} 80%{transform: translate(2px, -2px)} 100%{transform: translate(0)} }
    @keyframes fx-spin { 0%{transform: rotateY(0deg)} 100%{transform: rotateY(360deg)} }
    @keyframes fx-neon { 0%,100%{opacity: 1; filter: brightness(1)} 50%{opacity: 0.8; filter: brightness(1.5)} }
    @keyframes fx-wobble { 0%,100%{transform:rotate(0deg)} 25%{transform:rotate(-5deg)} 75%{transform:rotate(5deg)} }
    @keyframes fx-swing { 0%{transform:rotate(0deg)} 20%{transform:rotate(15deg)} 40%{transform:rotate(-10deg)} 60%{transform:rotate(5deg)} 80%{transform:rotate(-5deg)} 100%{transform:rotate(0deg)} }
    @keyframes fx-bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-30px);} 60% {transform: translateY(-15px);} }
    @keyframes fx-flip { 0% {transform: rotateY(0);} 100% {transform: rotateY(360deg);} }
    @keyframes fx-ghost { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(1.05); } }

  </style>

  <!-- ЭКРАН 1: ВЫБОР ЯЗЫКА -->
  <div class="view-landing" id="view_landing">
    <div class="landing-title">БИТВА<br>С БОССОМ</div>
    <div class="lang-select">
      <div class="btn-lang" onclick="app.setLang('ru')">RU</div>
      <div class="btn-lang" onclick="app.setLang('en')">EN</div>
    </div>
  </div>

  <!-- ЭКРАН 2: РЕДАКТОР -->
  <div class="view-editor" id="view_editor">
    
    <!-- ПАНЕЛЬ УПРАВЛЕНИЯ -->
    <div class="sidebar">
      <div class="tabs-header">
        <button class="tab-link active" onclick="app.tab('hero')" id="t_hero">ГЕРОЙ</button>
        <button class="tab-link" onclick="app.tab('boss')" id="t_boss">БОСС</button>
        <button class="tab-link" onclick="app.tab('quest')" id="t_quest">КВЕСТ</button>
      </div>

      <!-- ГЕРОЙ -->
      <div class="tab-content show" id="p_hero">
        <div class="control-group">
          <span class="control-label" id="l_h_name">Имя</span>
          <input type="text" class="fx-input" id="i_h_name" value="Student">
          <button class="fx-btn" style="width:100%" onclick="document.getElementById('f_hero').click()" id="b_h_up">ЗАГРУЗИТЬ КАРТИНКУ</button>
          <input type="file" id="f_hero" hidden accept="image/*">
          <input type="text" class="fx-input" id="u_hero" placeholder="URL..." style="margin-top:5px">
        </div>
        
        <div class="control-group">
          <span class="control-label" id="l_h_anim">Анимация</span>
          <div class="anim-grid" id="ag_hero"></div>
        </div>

        <div class="control-group">
          <span class="control-label" id="l_h_set">Настройки</span>
          <label style="font-size:9px; color:#888;">Size / Размер</label>
          <input type="range" id="r_h_size" min="50" max="150" value="100">
          <label style="font-size:9px; color:#888;">Opacity / Прозрачность</label>
          <input type="range" id="r_h_op" min="0" max="100" value="100">
          <div style="display:flex; gap:5px; margin-top:5px; align-items:center;">
             <label style="font-size:9px; color:#888;">Glow:</label>
             <input type="color" id="c_h_glow" value="#00e5ff" style="border:none; width:20px; height:20px; background:none; padding:0;">
             <input type="range" id="r_h_glow" min="0" max="50" value="0">
          </div>
        </div>
      </div>

      <!-- БОСС -->
      <div class="tab-content" id="p_boss">
        <div class="control-group">
          <span class="control-label" id="l_b_name">Имя</span>
          <input type="text" class="fx-input" id="i_b_name" value="BOSS">
          <button class="fx-btn" style="width:100%" onclick="document.getElementById('f_boss').click()" id="b_b_up">ЗАГРУЗИТЬ КАРТИНКУ</button>
          <input type="file" id="f_boss" hidden accept="image/*">
          <input type="text" class="fx-input" id="u_boss" placeholder="URL..." style="margin-top:5px">
        </div>

        <div class="control-group">
          <span class="control-label" id="l_b_anim">Анимация</span>
          <div class="anim-grid" id="ag_boss"></div>
        </div>

        <div class="control-group">
          <span class="control-label" id="l_b_set">Настройки</span>
          <label style="font-size:9px; color:#888;">Size / Размер</label>
          <input type="range" id="r_b_size" min="50" max="150" value="100">
          <label style="font-size:9px; color:#888;">Opacity / Прозрачность</label>
          <input type="range" id="r_b_op" min="0" max="100" value="100">
           <div style="display:flex; gap:5px; margin-top:5px; align-items:center;">
             <label style="font-size:9px; color:#888;">Glow:</label>
             <input type="color" id="c_b_glow" value="#ff0055" style="border:none; width:20px; height:20px; background:none; padding:0;">
             <input type="range" id="r_b_glow" min="0" max="50" value="0">
          </div>
        </div>
      </div>

      <!-- КВЕСТ -->
      <div class="tab-content" id="p_quest">
        <!-- Фон -->
        <div class="control-group">
            <span class="control-label" id="l_bg">Фон игры</span>
            <button class="fx-btn" style="width:100%" onclick="document.getElementById('f_bg').click()" id="b_bg_up">ЗАГРУЗИТЬ ФОН</button>
            <input type="file" id="f_bg" hidden accept="image/*">
        </div>

        <!-- Таймер -->
        <div class="control-group">
            <div class="toggle-row">
                <span class="control-label" style="margin:0" id="l_timer">Таймер (мин)</span>
                <input type="checkbox" id="chk_timer">
            </div>
            <input type="range" id="r_timer" min="1" max="30" value="5">
            <div style="text-align:right; font-size:10px; color:var(--cyan);"><span id="val_timer">5</span> min</div>
        </div>

        <!-- Тип задания -->
        <div class="control-group">
            <span class="control-label" id="l_q_type">Тип задания</span>
            <div class="type-switch">
                <div class="type-btn active" onclick="app.setQType('choice')" id="b_choice">ВЫБОР</div>
                <div class="type-btn" onclick="app.setQType('input')" id="b_input">ВВОД</div>
            </div>
            
            <span class="control-label" id="l_q_txt">Текст вопроса</span>
            <textarea class="fx-textarea" id="i_q_text" rows="2">Сколько будет 2 + 2?</textarea>

            <!-- Поля для ВЫБОРА -->
            <div id="area_choice">
                <span class="control-label" style="color:var(--green)" id="l_corr">Верный ответ</span>
                <input type="text" class="fx-input" id="i_c_ans" value="4">
                <span class="control-label" style="color:var(--pink)" id="l_wr">Неверные ответы</span>
                <input type="text" class="fx-input" id="i_w1" value="5">
                <input type="text" class="fx-input" id="i_w2" value="22">
            </div>

            <!-- Поля для ВВОДА -->
            <div id="area_input" style="display:none">
                <span class="control-label" style="color:var(--green)" id="l_code">Правильный текст</span>
                <input type="text" class="fx-input" id="i_in_ans" value="4">
                <div style="font-size:9px; color:#666; margin-top:2px;">* Регистр не важен</div>
            </div>
        </div>
        
        <div class="control-group">
             <span class="control-label" id="l_win">Сообщение Победы</span>
             <input type="text" class="fx-input" id="i_win_msg" value="VICTORY!">
        </div>
      </div>

    </div>

    <!-- СЦЕНА -->
    <div class="stage" id="stage_bg">
      <div class="stage-overlay"></div>
      <div class="battle-preview">
         <div class="char-box" id="box_hero">
             <img src="https://cdn-icons-png.flaticon.com/512/3408/3408506.png" class="char-img" id="img_hero">
         </div>
         <div class="char-box" id="box_boss">
             <img src="https://cdn-icons-png.flaticon.com/512/2312/2312264.png" class="char-img" id="img_boss" style="filter: hue-rotate(-20deg);">
         </div>
      </div>

      <div class="code-dock">
          <button class="btn-generate" onclick="app.generate()" id="b_gen">СГЕНЕРИРОВАТЬ КОД</button>
      </div>
    </div>
    
    <textarea id="hidden_code"></textarea>

  </div>

  <script>
    const app = {
      lang: 'en',
      qType: 'choice',
      data: {
         hero: { src: 'https://cdn-icons-png.flaticon.com/512/3408/3408506.png', anim: 'idle', size: 100, op: 100, gC: '#00e5ff', gP: 0 },
         boss: { src: 'https://cdn-icons-png.flaticon.com/512/2312/2312264.png', anim: 'idle', size: 100, op: 100, gC: '#ff0055', gP: 0 },
         bg: '',
         timer: 5,
         timerOn: false
      },
      text: {
        ru: {
          tabs: ['ГЕРОЙ', 'БОСС', 'КВЕСТ'],
          lbls: ['Имя', 'Загрузить картинку', 'Анимация', 'Настройки', 'Загрузить фон', 'Таймер (мин)', 'Тип задания', 'Текст вопроса', 'Верный ответ', 'Неверные ответы', 'Правильный текст', 'Сообщение Победы'],
          btns: ['ВЫБОР', 'ВВОД', 'СГЕНЕРИРОВАТЬ КОД']
        },
        en: {
          tabs: ['HERO', 'BOSS', 'QUEST'],
          lbls: ['Name', 'Upload Image', 'Animation', 'Settings', 'Upload Background', 'Timer (min)', 'Quest Type', 'Question Text', 'Correct Answer', 'Wrong Answers', 'Correct Text', 'Win Message'],
          btns: ['CHOICE', 'INPUT', 'GENERATE CODE']
        }
      },
      anims: ['none','idle','float','pulse','shake','glitch','spin','neon','wobble','swing','bounce','flip','ghost'],

      init() {
        this.renderAnims('hero');
        this.renderAnims('boss');
        this.bindEvents();
      },

      setLang(l) {
        this.lang = l;
        document.getElementById('view_landing').classList.add('hidden');
        document.getElementById('view_editor').classList.add('visible');
        this.translate();
      },

      translate() {
        const t = this.text[this.lang];
        const e = (id, txt) => document.getElementById(id).innerText = txt;
        
        e('t_hero', t.tabs[0]); e('t_boss', t.tabs[1]); e('t_quest', t.tabs[2]);
        
        ['l_h_name','l_b_name'].forEach(i => e(i, t.lbls[0]));
        ['b_h_up','b_b_up'].forEach(i => e(i, t.lbls[1]));
        ['l_h_anim','l_b_anim'].forEach(i => e(i, t.lbls[2]));
        ['l_h_set','l_b_set'].forEach(i => e(i, t.lbls[3]));
        
        e('l_bg', t.lbls[4]); e('b_bg_up', t.lbls[4]);
        e('l_timer', t.lbls[5]); e('l_q_type', t.lbls[6]); e('l_q_txt', t.lbls[7]);
        e('l_corr', t.lbls[8]); e('l_wr', t.lbls[9]); e('l_code', t.lbls[10]); e('l_win', t.lbls[11]);
        
        e('b_choice', t.btns[0]); e('b_input', t.btns[1]); e('b_gen', t.btns[2]);
      },

      tab(t) {
        document.querySelectorAll('.tab-link').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(p => p.classList.remove('show'));
        document.getElementById('t_'+t).classList.add('active');
        document.getElementById('p_'+t).classList.add('show');
      },

      setQType(t) {
        this.qType = t;
        document.getElementById('b_choice').className = t==='choice'?'type-btn active':'type-btn';
        document.getElementById('b_input').className = t==='input'?'type-btn active':'type-btn';
        document.getElementById('area_choice').style.display = t==='choice'?'block':'none';
        document.getElementById('area_input').style.display = t==='input'?'block':'none';
      },

      renderAnims(target) {
        const grid = document.getElementById('ag_'+target);
        grid.innerHTML = '';
        this.anims.forEach(a => {
           const b = document.createElement('div');
           b.className = 'fx-btn' + (this.data[target].anim === a ? ' active' : '');
           b.innerText = a;
           b.onclick = () => {
             this.data[target].anim = a;
             this.renderAnims(target);
             this.updatePreview();
           };
           grid.appendChild(b);
        });
      },

      handleImage(file, target, isBg = false) {
        if(file) {
           const r = new FileReader();
           r.onload = (e) => {
             if(isBg) { 
                 this.data.bg = e.target.result; 
                 document.getElementById('u_boss').classList.remove('upload-success'); 
             }
             else { 
                 this.data[target].src = e.target.result;
                 // Подсветка поля URL или Кнопки (визуально)
                 const btnId = isBg ? 'b_bg_up' : (target==='hero'?'b_h_up':'b_b_up');
                 const btn = document.getElementById(btnId);
                 btn.classList.add('upload-success');
                 setTimeout(()=>btn.classList.remove('upload-success'), 1000);
             }
             this.updatePreview();
           };
           r.readAsDataURL(file);
        }
      },

      bindEvents() {
         // File Uploads
         document.getElementById('f_hero').onchange = (e) => this.handleImage(e.target.files[0], 'hero');
         document.getElementById('f_boss').onchange = (e) => this.handleImage(e.target.files[0], 'boss');
         document.getElementById('f_bg').onchange = (e) => this.handleImage(e.target.files[0], null, true);
         
         // URL Inputs
         ['hero','boss'].forEach(t => {
             document.getElementById('u_'+t).oninput = (e) => {
                 if(e.target.value) { 
                     this.data[t].src = e.target.value; 
                     e.target.classList.add('upload-success');
                     this.updatePreview(); 
                 }
             };
         });

         // Sliders
         const bindS = (id, target, key) => document.getElementById(id).oninput = (e) => { this.data[target][key] = e.target.value; this.updatePreview(); };
         
         bindS('r_h_size','hero','size'); bindS('r_h_op','hero','op'); bindS('r_h_glow','hero','gP');
         bindS('r_b_size','boss','size'); bindS('r_b_op','boss','op'); bindS('r_b_glow','boss','gP');
         
         document.getElementById('c_h_glow').oninput = (e) => { this.data.hero.gC = e.target.value; this.updatePreview(); };
         document.getElementById('c_b_glow').oninput = (e) => { this.data.boss.gC = e.target.value; this.updatePreview(); };

         // Timer
         document.getElementById('chk_timer').onchange = (e) => this.data.timerOn = e.target.checked;
         document.getElementById('r_timer').oninput = (e) => {
             this.data.timer = e.target.value;
             document.getElementById('val_timer').innerText = e.target.value;
         }
      },

      updatePreview() {
         const h = this.data.hero;
         const b = this.data.boss;
         
         // Bg
         document.getElementById('stage_bg').style.backgroundImage = this.data.bg ? `url(${this.data.bg})` : 'none';

         // Helper style applier
         const apply = (elId, d) => {
             const img = document.getElementById(elId);
             img.src = d.src;
             // Styles
             img.parentNode.style.width = (d.size * 0.4) + '%'; // Scale box
             img.style.opacity = d.op / 100;
             const filter = d.gP > 0 ? `drop-shadow(0 0 ${d.gP}px ${d.gC})` : 'none';
             img.style.filter = filter;
             
             // Anim
             let dur = 2;
             if(['shake','wobble'].includes(d.anim)) dur = 0.8;
             if(['flip','ghost'].includes(d.anim)) dur = 3;
             
             let timing = d.anim === 'glitch' ? 'steps(2)' : 'ease-in-out';
             if(['shake','spin','flip'].includes(d.anim)) timing = 'linear';
             if(['bounce'].includes(d.anim)) timing = 'ease';
             
             if(d.anim !== 'none') {
                 img.style.animation = `fx-${d.anim} ${dur}s infinite ${timing}`;
                 if(d.anim === 'swing') img.style.transformOrigin = 'top center';
                 else img.style.transformOrigin = 'center';
             } else {
                 img.style.animation = 'none';
             }
         };

         apply('img_hero', h);
         apply('img_boss', b);
      },

      generate() {
         const d = this.data;
         const qData = {
             hName: document.getElementById('i_h_name').value,
             bName: document.getElementById('i_b_name').value,
             qText: document.getElementById('i_q_text').value,
             win: document.getElementById('i_win_msg').value,
             correct: this.qType === 'choice' ? document.getElementById('i_c_ans').value : document.getElementById('i_in_ans').value,
             wrongs: [document.getElementById('i_w1').value, document.getElementById('i_w2').value]
         };

         // Build CSS for Animations
         const getAnimRule = (o) => {
             if(o.anim === 'none') return '';
             let dur = 2;
             if(['shake','wobble'].includes(o.anim)) dur = 0.8;
             if(['flip','ghost'].includes(o.anim)) dur = 3;
             let timing = o.anim === 'glitch' ? 'steps(2)' : 'ease-in-out';
             if(['shake','spin','flip'].includes(o.anim)) timing = 'linear';
             if(['bounce'].includes(o.anim)) timing = 'ease';
             let origin = o.anim==='swing' ? 'transform-origin:top center;' : '';
             return `animation: fx-${o.anim} ${dur}s infinite ${timing}; ${origin}`;
         };

         const hStyle = `width:${d.hero.size}%; opacity:${d.hero.op/100}; filter:${d.hero.gP>0?`drop-shadow(0 0 ${d.hero.gP}px ${d.hero.gC})`:''}; ${getAnimRule(d.hero)}`;
         const bStyle = `width:${d.boss.size}%; opacity:${d.boss.op/100}; filter:${d.boss.gP>0?`drop-shadow(0 0 ${d.boss.gP}px ${d.boss.gC})`:''}; ${getAnimRule(d.boss)}`;

         // Logic Script
         const script = `
<script>
  let timerVal = ${d.timer * 60};
  let timerOn = ${d.timerOn};
  
  function startTimer() {
    if(!timerOn) return;
    const el = document.getElementById('timer-disp');
    const interval = setInterval(() => {
        timerVal--;
        let m = Math.floor(timerVal / 60);
        let s = timerVal % 60;
        el.innerText = m + ':' + (s < 10 ? '0'+s : s);
        if(timerVal <= 0) {
            clearInterval(interval);
            alert("TIME OVER!");
            location.reload();
        }
    }, 1000);
  }
  
  function checkChoice(btn, isCor) {
      if(isCor) win();
      else fail(btn);
  }
  
  function checkInput() {
      const val = document.getElementById('inp-ans').value.trim().toLowerCase();
      const cor = "${qData.correct}".trim().toLowerCase();
      if(val === cor) win();
      else failInput();
  }
  
  function win() {
      document.getElementById('boss-img').style.opacity = '0';
      document.getElementById('boss-img').style.transform = 'scale(0)';
      document.getElementById('hero-img').style.animation = 'fx-bounce 0.5s ease infinite';
      document.getElementById('q-panel').innerHTML = "<h2 style='color:#00ff88; text-shadow:0 0 10px #00ff88'>${qData.win}</h2>";
  }
  
  function fail(el) {
      el.style.background = '#ff0055';
      el.style.color = '#fff';
      document.body.style.animation = 'fx-shake 0.3s linear';
      setTimeout(() => { 
          el.style.background = '#444'; 
          document.body.style.animation = 'none';
      }, 1000);
  }
  
  function failInput() {
      const i = document.getElementById('inp-ans');
      i.style.borderColor = '#ff0055';
      document.body.style.animation = 'fx-shake 0.3s linear';
      setTimeout(() => { 
          i.style.borderColor = '#fff'; 
          document.body.style.animation = 'none';
      }, 1000);
  }
  
  startTimer();
<\/script>`;

         // Inputs UI
         let inputHtml = '';
         if(this.qType === 'choice') {
             const ans = [{t:qData.correct, c:true}, {t:qData.wrongs[0], c:false}];
             if(qData.wrongs[1]) ans.push({t:qData.wrongs[1], c:false});
             ans.sort(()=>Math.random()-0.5);
             inputHtml = `<div class="btns">${ans.map(a => `<button class="game-btn" onclick="checkChoice(this, ${a.c})">${a.t}</button>`).join('')}</div>`;
         } else {
             inputHtml = `<div class="inp-area"><input type="text" id="inp-ans" placeholder="Answer..."><button class="game-btn" onclick="checkInput()">SUBMIT</button></div>`;
         }

         const html = `
<!DOCTYPE html>
<html>
<head>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@700&display=swap');
body { margin:0; overflow:hidden; font-family:'Rajdhani',sans-serif; user-select:none; width:100vw; height:100vh;
background: ${d.bg ? `url(${d.bg}) center/cover` : 'transparent'}; }

/* Keyframes copied from editor */
@keyframes fx-idle { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
@keyframes fx-float { 0%,100%{transform:translateY(0) rotate(0deg)} 50%{transform:translateY(-15px) rotate(2deg)} }
@keyframes fx-pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
@keyframes fx-shake { 0%{transform: translate(1px, 1px)} 20%{transform: translate(-3px, 0px)} 40%{transform: translate(1px, -1px)} 60%{transform: translate(-3px, 1px)} 80%{transform: translate(-1px, -1px)} 100%{transform: translate(1px, -2px)} }
@keyframes fx-glitch { 0%{transform: translate(0)} 20%{transform: translate(-2px, 2px)} 40%{transform: translate(-2px, -2px)} 60%{transform: translate(2px, 2px)} 80%{transform: translate(2px, -2px)} 100%{transform: translate(0)} }
@keyframes fx-spin { 0%{transform: rotateY(0deg)} 100%{transform: rotateY(360deg)} }
@keyframes fx-neon { 0%,100%{opacity: 1; filter: brightness(1)} 50%{opacity: 0.8; filter: brightness(1.5)} }
@keyframes fx-wobble { 0%,100%{transform:rotate(0deg)} 25%{transform:rotate(-5deg)} 75%{transform:rotate(5deg)} }
@keyframes fx-swing { 0%{transform:rotate(0deg)} 20%{transform:rotate(15deg)} 40%{transform:rotate(-10deg)} 60%{transform:rotate(5deg)} 80%{transform:rotate(-5deg)} 100%{transform:rotate(0deg)} }
@keyframes fx-bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-30px);} 60% {transform: translateY(-15px);} }
@keyframes fx-flip { 0% {transform: rotateY(0);} 100% {transform: rotateY(360deg);} }
@keyframes fx-ghost { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(1.05); } }

.scene { display:flex; flex-direction:column; height:100%; justify-content:space-between; position:relative; }
.hud { padding:10px; display:flex; justify-content:space-between; z-index:10; color:#fff; font-weight:900; text-shadow:2px 2px 0 #000; font-size:18px; }
.timer { color:#ffcc00; }

.stage { flex:1; display:flex; justify-content:space-between; align-items:flex-end; padding:0 10%; perspective:1000px; }
.char-wrap { width:40%; height:80%; display:flex; align-items:flex-end; justify-content:center; }
.char { max-width:100%; max-height:100%; object-fit:contain; transition:0.5s; }

.ui-panel { background:rgba(20,20,30,0.95); padding:15px; border-top:3px solid #00e5ff; display:flex; flex-direction:column; align-items:center; gap:10px; min-height:150px; }
.q-text { color:#fff; font-size:20px; font-weight:700; text-align:center; }

.btns { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; width:100%; }
.game-btn { background:#444; border:2px solid #666; color:#fff; padding:12px 20px; font-family:inherit; font-weight:700; font-size:16px; cursor:pointer; text-transform:uppercase; border-radius:6px; transition:0.2s; min-width:120px; }
.game-btn:hover { background:#666; border-color:#fff; }

.inp-area { display:flex; gap:10px; }
input[type=text] { padding:10px; border-radius:4px; border:2px solid #fff; font-family:inherit; font-weight:700; background:#000; color:#fff; }

</style>
</head>
<body>
<div class="scene">
  <div class="hud">
    <div>${qData.hName}</div>
    <div class="timer" id="timer-disp">${d.timerOn ? d.timer+':00' : ''}</div>
    <div>${qData.bName}</div>
  </div>
  
  <div class="stage">
     <div class="char-wrap"><img src="${d.hero.src}" class="char" id="hero-img" style="${hStyle}"></div>
     <div class="char-wrap"><img src="${d.boss.src}" class="char" id="boss-img" style="${bStyle}"></div>
  </div>

  <div class="ui-panel" id="q-panel">
     <div class="q-text">${qData.qText}</div>
     ${inputHtml}
  </div>
</div>
${script}
</body>
</html>`;

         const area = document.getElementById('hidden_code');
         area.value = `<iframe srcdoc="${html.replace(/"/g, '&quot;')}" width="100%" height="100%" frameborder="0" style="background:transparent;"></iframe>`;
         area.select();
         document.execCommand('copy');
         
         const btn = document.getElementById('b_gen');
         const old = btn.innerText;
         btn.innerText = "OK!";
         btn.style.borderColor = "#00ff88";
         btn.style.color = "#00ff88";
         setTimeout(() => {
             btn.innerText = old;
             btn.style.borderColor = "#fff";
             btn.style.color = "#fff";
         }, 1500);
      }
    };

    app.init();
  </script>
</div>
